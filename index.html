<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano Banana å›¾åƒç”Ÿæˆä¸ç¼–è¾‘å·¥å…·</title>
    
    <!-- Supabaseå®¢æˆ·ç«¯åº“ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            padding: 40px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            align-items: start;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
        }

        .right-panel {
            position: sticky;
            top: 20px;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            min-height: 400px;
            border: 2px solid #e9ecef;
        }

        .right-panel h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .initial-placeholder {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .placeholder-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .initial-placeholder h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .initial-placeholder p {
            line-height: 1.6;
            color: #666;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 40px;
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ä¸»æ ‡ç­¾é¡µæ ·å¼ */
        .main-tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
        }

        .main-tab-button {
            flex: 1;
            padding: 15px 30px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
        }

        .main-tab-button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .main-tab-content {
            display: none;
        }

        .main-tab-content.active {
            display: block;
        }

        /* ç¼–è¾‘å™¨æ ‡ç­¾é¡µæ ·å¼ */
        .editor-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 10px;
        }

        .editor-tab-button {
            background: none;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            position: relative;
        }

        .editor-tab-button:hover {
            color: #667eea;
            background: #f8f9fa;
        }

        .editor-tab-button.active {
            color: #667eea;
            background: #f8f9fa;
            font-weight: 600;
        }

        .editor-tab-content {
            display: none;
        }

        .editor-tab-content.active {
            display: block;
        }

        .input-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: white;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-display {
            padding: 15px;
            border: 2px dashed #667eea;
            border-radius: 10px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-input-display:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }

        .file-input-display.has-file {
            border-style: solid;
            background: #e8f4fd;
        }

        .generate-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }



        .result {
            margin-top: 0;
            padding: 0;
            background: transparent;
            border-radius: 0;
            text-align: center;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .result.show {
            display: block;
            opacity: 1;
        }
        
        /* å†…è”ç”ŸæˆçŠ¶æ€æç¤ºæ ·å¼ */
        .generation-status-inline {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .generation-status-inline p {
            margin: 20px 0 0 0;
            font-size: 16px;
            color: #333;
        }
        
        .status-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #764ba2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-image-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .result img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .result img:hover {
            transform: scale(1.02);
        }

        .image-hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* å›¾åƒæ”¾å¤§æ¨¡æ€æ¡†æ ·å¼ä¼˜åŒ– */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
        }

        .modal-content {
            position: relative;
            margin: 2% auto;
            padding: 20px;
            width: 95%;
            max-width: 1400px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .close-modal {
            position: absolute;
            right: 25px;
            top: 20px;
            font-size: 32px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            transition: color 0.3s ease;
            z-index: 1001;
        }

        .close-modal:hover {
            color: #333;
        }

        #modal-image {
            max-width: 100%;
            max-height: 80vh;
            width: auto;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            object-fit: contain;
            transition: all 0.3s ease;
            cursor: zoom-in;
        }





        .download-btn {
            padding: 12px 30px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .download-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .result-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .reference-btn {
            padding: 12px 30px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reference-btn:hover {
            background: #138496;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
        }

        .preview-container {
            margin-top: 20px;
            text-align: center;
        }

        .preview-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 0 0 20px 0;
            border: 1px solid #f5c6cb;
            display: none;
        }

        .error.show {
            display: block;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
            display: none;
        }

        .success-message.show {
            display: block;
        }
        
        /* åŠ è½½æ¶ˆæ¯æ ·å¼ */
        .loading-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            z-index: 10000;
            display: none;
            backdrop-filter: blur(10px);
            border: 1px solid #e9ecef;
        }
        
        .loading-message.show {
            display: block;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å¤šå›¾ä¸Šä¼ æ ·å¼ */
        .multi-file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .multi-file-input-display {
            padding: 15px;
            border: 2px dashed #667eea;
            border-radius: 10px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .multi-file-input-display:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }

        .multi-file-input-display.has-files {
            border-style: solid;
            background: #e8f5e8;
            color: #28a745;
        }

        .multi-preview-container {
            margin-top: 15px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 8px;
        }

        .image-count {
            font-weight: 600;
            color: #333;
        }

        .clear-all-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-all-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        #multi-preview-images {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .multi-preview-item {
            position: relative;
            display: inline-block;
        }

        .multi-preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .remove-image-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #dc3545;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .remove-image-btn:hover {
            background: #c82333;
        }

        .upload-hint {
            margin-top: 8px;
            color: #666;
            font-size: 12px;
        }

        .upload-hint small {
            color: #888;
        }

        .upload-modes {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .upload-mode-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .upload-mode-option:hover {
            background: #f8f9fa;
        }

        .upload-mode-option input[type="radio"] {
            margin: 0;
            cursor: pointer;
        }

        .upload-mode-option input[type="radio"]:checked + span {
            color: #667eea;
            font-weight: 600;
        }

        .upload-mode-option:has(input[type="radio"]:checked) {
            border-color: #667eea;
            background: #f0f4ff;
        }

        /* å¤´éƒ¨å®¹å™¨æ ·å¼ */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .google-login-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3);
        }

        .google-login-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
        }

        .google-icon {
            width: 18px;
            height: 18px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: #f8f9fa;
            border-radius: 25px;
            border: 2px solid #e9ecef;
        }

        .user-avatar img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .user-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .user-email {
            color: #666;
            font-size: 12px;
        }

        .logout-btn {
            padding: 6px 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        /* å†å²è®°å½•æ ·å¼ */
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .history-filters {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .history-filters select,
        .history-filters input {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
        }

        .history-filters input {
            min-width: 200px;
        }

        .history-list {
            min-height: 200px;
        }

        .history-placeholder {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .history-item {
            display: flex;
            gap: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }

        .history-item-image {
            width: 120px;
            height: 120px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
        }

        .history-item-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .history-item-type {
            display: inline-block;
            padding: 4px 8px;
            background: #667eea;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .history-item-prompt {
            font-size: 14px;
            color: #333;
            line-height: 1.4;
        }

        .history-item-date {
            font-size: 12px;
            color: #666;
        }

        .history-item-actions {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        .history-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-download-btn {
            background: #28a745;
            color: white;
        }

        .history-download-btn:hover {
            background: #218838;
        }

        .history-reference-btn {
            background: #17a2b8;
            color: white;
        }

        .history-reference-btn:hover {
            background: #138496;
        }
        
        .history-delete-btn {
            background: #dc3545;
            color: white;
        }
        
        .history-delete-btn:hover {
            background: #c82333;
        }
        
        .sync-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .history-count-info {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            color: #666;
            font-size: 12px;
        }
        
        /* å†å²è®°å½•åŒæ­¥çŠ¶æ€æ ·å¼ */
        .history-sync-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 8px;
            color: #666;
            font-size: 14px;
        }
        
        .sync-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e9ecef;
            border-top: 2px solid #764ba2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            h1 {
                font-size: 2em;
            }

            .main-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .right-panel {
                position: static;
                order: -1;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-button {
                margin-bottom: 5px;
            }

            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 15px;
            }

            .modal-actions {
                flex-direction: column;
                gap: 10px;
            }

            .modal-download-btn, .modal-close-btn, .modal-reference-btn, .modal-zoom-btn {
                width: 100%;
            }


        }
    </style>
</head>
<body>
    <!-- å›¾åƒæ”¾å¤§æ¨¡æ€æ¡† - æ”¾åœ¨bodyä¸‹é¿å…å †å ä¸Šä¸‹æ–‡é—®é¢˜ -->
    <div id="image-modal" class="image-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeImageModal()">&times;</span>
            <img id="modal-image" src="" alt="æ”¾å¤§å›¾åƒ">
        </div>
    </div>
    
    <div class="container">
                <div class="header-container">
                    <h1>ğŸŒ Nano Banana AI å›¾åƒå·¥å…·</h1>
                    <div class="user-section">
                        <div id="login-section" class="login-section">
                            <button id="google-login-btn" class="google-login-btn" onclick="googleLogin()">
                                <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="google-icon">
                                ä½¿ç”¨Googleè´¦å·ç™»å½•
                            </button>
                        </div>
                        <div id="user-info" class="user-info" style="display: none;">
                            <div class="user-avatar">
                                <img id="user-avatar-img" src="" alt="ç”¨æˆ·å¤´åƒ">
                            </div>
                            <div class="user-details">
                                <span id="user-name" class="user-name"></span>
                                <span id="user-email" class="user-email"></span>
                            </div>
                            <button id="logout-btn" class="logout-btn" onclick="googleLogout()">ç™»å‡º</button>
                        </div>
                    </div>
                </div>

        <div class="main-layout">
            <div class="left-panel">
                <div class="main-tabs">
                    <button class="main-tab-button active" onclick="switchMainTab('editor', event)">Editor</button>
                    <button class="main-tab-button" onclick="switchMainTab('history', event)" id="history-main-tab" style="display: none;">History</button>
                </div>

                <!-- Editor Tab - ç”ŸæˆåŠŸèƒ½ -->
                <div id="editor-tab" class="main-tab-content active">
                    <div class="editor-tabs">
                        <button class="editor-tab-button active" onclick="switchEditorTab('text-to-image', event)">æ–‡æœ¬ç”Ÿæˆå›¾åƒ</button>
                        <button class="editor-tab-button" onclick="switchEditorTab('multi-image', event)">å›¾åƒç¼–è¾‘</button>
                    </div>

                    <!-- æ–‡æœ¬ç”Ÿæˆå›¾åƒ -->
                    <div id="text-to-image" class="editor-tab-content active">
                        <div class="input-group">
                            <label for="text-prompt">æè¿°æç¤ºè¯</label>
                            <textarea id="text-prompt" placeholder="è¯·è¾“å…¥æ‚¨æƒ³è¦ç”Ÿæˆå›¾åƒçš„è¯¦ç»†æè¿°ï¼Œä¾‹å¦‚ï¼šCreate a picture of a nano banana dish in a fancy restaurant with a Gemini theme"></textarea>
                        </div>
                        <button class="generate-btn" onclick="generateFromText()">ç”Ÿæˆå›¾åƒ</button>
                    </div>

                    <!-- å›¾åƒç¼–è¾‘ -->
                    <div id="multi-image" class="editor-tab-content">
                        <div class="input-group">
                            <label for="multi-prompt">ç¼–è¾‘æç¤ºè¯</label>
                            <textarea id="multi-prompt" placeholder="è¯·è¾“å…¥æ‚¨æƒ³è¦å¯¹å›¾åƒè¿›è¡Œçš„ç¼–è¾‘æè¿°ï¼Œä¾‹å¦‚ï¼šCreate a professional e-commerce fashion photo. Take the blue floral dress from the first image and let the woman from the second image wear it. Generate a realistic, full-body shot of the woman wearing the dress, with the lighting and shadows adjusted to match the outdoor environment."></textarea>
                        </div>
                        <div class="input-group">
                            <label for="multi-images">æ·»åŠ å›¾åƒ (1-3å¼ )</label>
                            <div class="multi-file-input-wrapper">
                                <input type="file" id="multi-images" accept="image/*" multiple onchange="handleImageUpload(this)">
                                <div class="multi-file-input-display">
                                    <span id="multi-file-display-text">ç‚¹å‡»é€‰æ‹©å›¾åƒæ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</span>
                                </div>
                            </div>
                            <div class="upload-hint">
                                <small>æ”¯æŒJPEGã€PNGæ ¼å¼ï¼Œå•å¼ å›¾åƒæœ€å¤§10MBã€‚æ”¯æŒå•å¼ å›¾åƒç¼–è¾‘æˆ–å¤šå¼ å›¾åƒç»„åˆç¼–è¾‘</small>
                            </div>
                            <div id="multi-image-preview" class="multi-preview-container" style="display: none;">
                                <div class="preview-header">
                                    <span class="image-count">å·²æ·»åŠ  <span id="image-count">0</span> å¼ å›¾åƒï¼Œç‚¹å‡»å¯ç»§ç»­ä¸Šä¼ </span>
                                    <button class="clear-all-btn" onclick="clearAllImages()" title="æ¸…ç©ºæ‰€æœ‰å›¾åƒ">ğŸ—‘ï¸ æ¸…ç©º</button>
                                </div>
                                <div id="multi-preview-images"></div>
                            </div>
                        </div>
                        <button class="generate-btn" onclick="generateFromMultiImages()">ç¼–è¾‘å›¾åƒ</button>
                    </div>
                </div>

                <!-- History Tab - ç”Ÿæˆå†å² -->
                <div id="history-tab" class="main-tab-content">
                    <div class="history-header">
                        <h3>ç”Ÿæˆå†å²è®°å½•</h3>
                        <div class="history-filters">
                            <select id="history-type-filter" onchange="filterHistory()">
                                <option value="">å…¨éƒ¨ç±»å‹</option>
                                <option value="text-to-image">æ–‡æœ¬ç”Ÿæˆå›¾åƒ</option>
                                <option value="image-edit">å›¾åƒç¼–è¾‘</option>
                            </select>
                            <input type="text" id="history-search" placeholder="æœç´¢æç¤ºè¯..." oninput="searchHistory()">
                            <button class="clear-all-history-btn" onclick="clearAllHistory()" style="margin-left: 10px; padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">æ¸…ç©ºæ‰€æœ‰</button>
                        </div>
                    </div>
                    <div id="history-list" class="history-list">
                                            <div class="history-placeholder">
                        <p>æš‚æ— ç”Ÿæˆå†å²è®°å½•</p>
                        <small>ç”Ÿæˆå›¾åƒåï¼Œå†å²è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</small>
                    </div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="error">
                    <p id="error-message"></p>
                </div>

                <div class="result">
                    <h3>ç”Ÿæˆç»“æœ</h3>
                    <div class="result-image-container">
                        <img id="result-image" src="" alt="ç”Ÿæˆçš„å›¾åƒ" onclick="showImageModal(this.src)" class="clickable-image">
                        <div class="image-hint">ç‚¹å‡»å›¾åƒå¯æ”¾å¤§æŸ¥çœ‹</div>
                    </div>
                    <div class="result-actions">
                        <button class="download-btn" onclick="downloadImage()">ä¸‹è½½å›¾åƒ</button>
                        <button class="reference-btn" onclick="referenceImage()" title="å¼•ç”¨æ­¤å›¾åƒè¿›è¡Œä¸‹ä¸€æ¬¡ç¼–è¾‘">ğŸ“ å¼•ç”¨å›¾åƒ</button>
                    </div>
                </div>



                <!-- åˆå§‹çŠ¶æ€å ä½ç¬¦ -->
                <div id="initial-placeholder" class="initial-placeholder">
                    <div class="placeholder-icon">ğŸ¨</div>
                    <h3>AI å›¾åƒç”Ÿæˆä¸ç¼–è¾‘</h3>
                    <p>åœ¨å·¦ä¾§è¾“å…¥æç¤ºè¯å¹¶ä¸Šä¼ å›¾åƒï¼Œ<br>å³ä¾§å°†æ˜¾ç¤ºç”Ÿæˆç»“æœ</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('Script starting...');
        
        // APIé…ç½® - ç°åœ¨é€šè¿‡æœ¬åœ°æœåŠ¡å™¨ä»£ç†
        const API_BASE = window.location.origin; // ä½¿ç”¨å½“å‰åŸŸå
        const MODEL = 'gemini-2.5-flash-image-preview';
        
        let currentImageData = null;
        let selectedFile = null;
        let selectedMultiFiles = []; // å¤šå›¾é€‰æ‹©çš„æ–‡ä»¶æ•°ç»„
        
        // Googleç™»å½•ç›¸å…³å˜é‡
        let currentUser = null;
        let userHistory = [];
        let isLoggingOut = false; // é˜²æ­¢ç™»å½•/ç™»å‡ºç«æ€æ¡ä»¶çš„æ ‡å¿—
        
        // Google OAuth 2.0 é…ç½®
        // è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤é…ç½®ï¼š
        // 1. è®¿é—® https://console.cloud.google.com/
        // 2. åˆ›å»ºé¡¹ç›®æˆ–é€‰æ‹©ç°æœ‰é¡¹ç›®
        // 3. å¯ç”¨ Google+ API å’Œ Google OAuth2 API
        // 4. åœ¨"å‡­æ®"é¡µé¢åˆ›å»ºOAuth 2.0å®¢æˆ·ç«¯ID
        // 5. è®¾ç½®æˆæƒåŸŸåï¼ˆåŒ…æ‹¬ä½ çš„å¼€å‘åŸŸåï¼‰
        // 6. å°†è·å¾—çš„å®¢æˆ·ç«¯IDæ›¿æ¢ä¸‹é¢çš„å€¼
        //
        // ğŸš€ Verceléƒ¨ç½²é…ç½®ï¼š
        // æˆæƒJavaScriptæ¥æº: https://nano-banana-tool.vercel.app
        // æˆæƒé‡å®šå‘URI: https://nano-banana-tool.vercel.app/oauth-callback.html
        // æ³¨æ„ï¼šJavaScriptæ¥æºä¸è¦åŒ…å«ç»“å°¾æ–œæ æˆ–è·¯å¾„ï¼
        const GOOGLE_CLIENT_ID = '547002648100-ktofram0al1so1n8ii436bnv49hgikfk.apps.googleusercontent.com';
        const GOOGLE_SCOPE = 'openid email profile';
        
        // Supabaseé…ç½®
        // è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤é…ç½®ï¼š
        // 1. è®¿é—® https://supabase.com/ åˆ›å»ºé¡¹ç›®
        // 2. åœ¨é¡¹ç›®è®¾ç½®ä¸­è·å–URLå’Œanon key
        // 3. åˆ›å»ºä»¥ä¸‹æ•°æ®è¡¨ï¼š
        //    - users: id, email, name, avatar_url, created_at
        //    - history: id, user_id, type, prompt, result_image, input_images, created_at
        const SUPABASE_URL = 'https://cvdogeigbpussfamctsu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2ZG9nZWlnYnB1c3NmYW1jdHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NjEyMjUsImV4cCI6MjA3MjEzNzIyNX0.JSY1sEK1aLaqaIp5_MTM_99XERVaDY18akQeKCDYEik';
        
        // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
        let supabase = null;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('âœ… Supabaseå®¢æˆ·ç«¯å·²åˆå§‹åŒ–');
            console.log('Supabase URL:', SUPABASE_URL);
        } catch (error) {
            console.error('âŒ Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥:', error);
            console.warn('âš ï¸ å°†ä½¿ç”¨localStorageä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ');
        }

        // åˆ‡æ¢ä¸»æ ‡ç­¾é¡µï¼ˆEditor/Historyï¼‰
        function switchMainTab(tabId, event) {
            console.log('switchMainTab called with:', tabId, event);
            
            try {
                // éšè—æ‰€æœ‰ä¸»æ ‡ç­¾å†…å®¹
                document.querySelectorAll('.main-tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // ç§»é™¤æ‰€æœ‰ä¸»æ ‡ç­¾æŒ‰é’®çš„activeç±»
                document.querySelectorAll('.main-tab-button').forEach(button => {
                    button.classList.remove('active');
                });
                
                // æ˜¾ç¤ºé€‰ä¸­çš„ä¸»æ ‡ç­¾å†…å®¹
                const targetTab = document.getElementById(tabId + '-tab');
                if (targetTab) {
                    targetTab.classList.add('active');
                } else {
                    console.error('Target main tab not found:', tabId + '-tab');
                    return;
                }
                
                // æ¿€æ´»å¯¹åº”çš„ä¸»æ ‡ç­¾æŒ‰é’®
                if (event && event.target) {
                    event.target.classList.add('active');
                }
                
                // æ¸…é™¤ä¹‹å‰çš„ç»“æœå’Œé”™è¯¯
                hideResult();
                hideError();
                
                // éšè—æˆåŠŸæ¶ˆæ¯
                const successMessage = document.getElementById('success-message');
                if (successMessage) {
                    successMessage.classList.remove('show');
                }
                
                console.log('Main tab switched successfully to:', tabId);
            } catch (error) {
                console.error('Error in switchMainTab:', error);
            }
        }
        
        // åˆ‡æ¢ç¼–è¾‘å™¨æ ‡ç­¾é¡µï¼ˆæ–‡æœ¬ç”Ÿæˆå›¾åƒ/å›¾åƒç¼–è¾‘ï¼‰
        function switchEditorTab(tabId, event) {
            console.log('switchEditorTab called with:', tabId, event);
            
            try {
                // éšè—æ‰€æœ‰ç¼–è¾‘å™¨æ ‡ç­¾å†…å®¹
                document.querySelectorAll('.editor-tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // ç§»é™¤æ‰€æœ‰ç¼–è¾‘å™¨æ ‡ç­¾æŒ‰é’®çš„activeç±»
                document.querySelectorAll('.editor-tab-button').forEach(button => {
                    button.classList.remove('active');
                });
                
                // æ˜¾ç¤ºé€‰ä¸­çš„ç¼–è¾‘å™¨æ ‡ç­¾å†…å®¹
                const targetTab = document.getElementById(tabId);
                if (targetTab) {
                    targetTab.classList.add('active');
                } else {
                    console.error('Target editor tab not found:', tabId);
                    return;
                }
                
                // æ¿€æ´»å¯¹åº”çš„ç¼–è¾‘å™¨æ ‡ç­¾æŒ‰é’®
                if (event && event.target) {
                    event.target.classList.add('active');
                }
                
                // æ¸…ç©ºå¤šå›¾é€‰æ‹©
                if (tabId !== 'multi-image') {
                    selectedMultiFiles = [];
                    updateMultiImagePreview();
                } else {
                    // å¦‚æœåˆ‡æ¢åˆ°å›¾åƒç¼–è¾‘æ ‡ç­¾é¡µï¼Œæ˜¾ç¤ºå¼•ç”¨æç¤º
                    if (selectedMultiFiles.length > 0) {
                        showSuccessMessage(`å·²åŠ è½½ ${selectedMultiFiles.length} å¼ å›¾åƒï¼Œæ‚¨å¯ä»¥ç»§ç»­æ·»åŠ æ›´å¤šå›¾åƒæˆ–ç›´æ¥ç¼–è¾‘`);
                    }
                }
                
                console.log('Editor tab switched successfully to:', tabId);
            } catch (error) {
                console.error('Error in switchEditorTab:', error);
            }
        }
        
        // Googleç™»å½•ç›¸å…³å‡½æ•°
        function googleLogin() {
            // æ£€æŸ¥æ˜¯å¦å·²ç»ç™»å½•
            if (currentUser) {
                console.log('ç”¨æˆ·å·²ç™»å½•:', currentUser);
                return;
            }
            
            // æ£€æŸ¥Google Client IDæ˜¯å¦å·²é…ç½®
            if (GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') {
                showError('Googleç™»å½•æœªé…ç½®ã€‚è¯·å…ˆé…ç½®Google OAuthå®¢æˆ·ç«¯IDã€‚');
                console.error('Google OAuth Client ID not configured');
                return;
            }
            
            try {
                // ä½¿ç”¨Google Sign-In APIè·å–ç”¨æˆ·ä¿¡æ¯
                // è¿™ç§æ–¹å¼å¯ä»¥ç›´æ¥è·å–ç”¨æˆ·çš„é‚®ç®±ã€å§“åã€å¤´åƒç­‰ä¿¡æ¯
                
                // åˆ›å»ºGoogle Sign-InæŒ‰é’®
                const googleSignInButton = document.createElement('div');
                googleSignInButton.id = 'google-signin-button';
                googleSignInButton.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const signInContent = document.createElement('div');
                signInContent.style.cssText = `
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    text-align: center;
                `;
                
                signInContent.innerHTML = `
                    <h3 style="margin: 0 0 20px 0; color: #333;">Googleè´¦å·ç™»å½•</h3>
                    <p style="margin: 0 0 20px 0; color: #666;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä½¿ç”¨Googleè´¦å·ç™»å½•</p>
                    <div id="g_id_onload"
                         data-client_id="${GOOGLE_CLIENT_ID}"
                         data-context="signin"
                         data-ux_mode="popup"
                         data-callback="handleGoogleSignIn"
                         data-auto_prompt="false">
                    </div>
                    <div class="g_id_signin"
                         data-type="standard"
                         data-shape="rectangular"
                         data-theme="outline"
                         data-text="signin_with"
                         data-size="large"
                         data-logo_alignment="left">
                    </div>
                    <button onclick="closeGoogleSignInModal()" style="margin-top: 20px; padding: 10px 20px; border: none; border-radius: 8px; background: #6c757d; color: white; cursor: pointer;">å–æ¶ˆ</button>
                `;
                
                googleSignInButton.appendChild(signInContent);
                document.body.appendChild(googleSignInButton);
                
                // åŠ è½½Google Sign-In API
                loadGoogleSignInAPI();
                
            } catch (error) {
                console.error('Googleç™»å½•é”™è¯¯:', error);
                showError(`Googleç™»å½•å‡ºé”™: ${error.message}`);
            }
        }
        
        // åŠ è½½Google Sign-In API
        function loadGoogleSignInAPI() {
            if (window.google && window.google.accounts) {
                console.log('Google Sign-In API å·²åŠ è½½');
                return;
            }
            
            const script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.async = true;
            script.defer = true;
            script.onload = function() {
                console.log('Google Sign-In API åŠ è½½å®Œæˆ');
            };
            script.onerror = function() {
                console.error('Google Sign-In API åŠ è½½å¤±è´¥');
                showError('Googleç™»å½•æœåŠ¡åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            };
            document.head.appendChild(script);
        }
        
        // å…³é—­Googleç™»å½•æ¨¡æ€æ¡†
        function closeGoogleSignInModal() {
            const modal = document.getElementById('google-signin-button');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        // å¤„ç†Google Sign-Inå›è°ƒ
        function handleGoogleSignIn(response) {
            console.log('Google Sign-In å“åº”:', response);
            
            if (response.credential) {
                // è§£ç JWTä»¤ç‰Œè·å–ç”¨æˆ·ä¿¡æ¯
                const payload = JSON.parse(atob(response.credential.split('.')[1]));
                console.log('è§£ç çš„ç”¨æˆ·ä¿¡æ¯:', payload);
                
                // åˆ›å»ºç”¨æˆ·å¯¹è±¡ - ä½¿ç”¨ç¨³å®šçš„é‚®ç®±å“ˆå¸Œä½œä¸ºIDï¼Œç¡®ä¿åŒä¸€é‚®ç®±æ¯æ¬¡ç™»å½•éƒ½æ˜¯ç›¸åŒID
                const emailHash = btoa(payload.email).replace(/[^a-zA-Z0-9]/g, '');
                const stableUserId = `google_${emailHash}`;
                
                const googleUser = {
                    id: stableUserId,
                    email: payload.email,
                    name: payload.name || payload.email.split('@')[0],
                    avatar: payload.picture,
                    googleId: payload.sub,
                    picture: payload.picture
                };
                
                console.log('åˆ›å»ºçš„ç”¨æˆ·å¯¹è±¡:', googleUser);
                
                // å…³é—­æ¨¡æ€æ¡†
                closeGoogleSignInModal();
                
                // ç™»å½•ç”¨æˆ·
                loginUser(googleUser);
                
            } else {
                console.error('Google Sign-In å¤±è´¥: æ²¡æœ‰è·å–åˆ°å‡­æ®');
                showError('Googleç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰ç›¸åŒé‚®ç®±çš„ç°æœ‰ç”¨æˆ·æ•°æ®
        function checkExistingUserData(email) {
            console.log('æ£€æŸ¥é‚®ç®±çš„ç°æœ‰ç”¨æˆ·æ•°æ®:', email);
            
            // æ£€æŸ¥localStorageä¸­æ˜¯å¦æœ‰ç›¸åŒé‚®ç®±çš„ç”¨æˆ·
            const savedUser = localStorage.getItem('nanoBananaUser');
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    if (user.email === email) {
                        console.log('æ‰¾åˆ°localStorageä¸­ç›¸åŒé‚®ç®±çš„ç”¨æˆ·:', user);
                        return user;
                    }
                } catch (error) {
                    console.error('è§£æä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ç›¸åŒé‚®ç®±çš„å†å²è®°å½•
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.includes('nanoBananaHistory')) {
                    try {
                        const historyData = localStorage.getItem(key);
                        if (historyData) {
                            const history = JSON.parse(historyData);
                            // å¦‚æœå†å²è®°å½•ä¸­æœ‰æ•°æ®ï¼Œè¯´æ˜è¿™ä¸ªç”¨æˆ·ä¹‹å‰ç™»å½•è¿‡
                            if (history.length > 0) {
                                // å°è¯•ä»keyä¸­æå–é‚®ç®±ä¿¡æ¯
                                const keyParts = key.split('_');
                                if (keyParts.length >= 2) {
                                    const potentialEmail = atob(keyParts[1]);
                                    if (potentialEmail === email) {
                                        console.log('æ‰¾åˆ°ç›¸åŒé‚®ç®±çš„å†å²è®°å½•ï¼Œç”¨æˆ·ID:', keyParts[1]);
                                        return { id: keyParts[1] };
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error('æ£€æŸ¥å†å²è®°å½•å¤±è´¥:', error);
                    }
                }
            }
            
            console.log('æ²¡æœ‰æ‰¾åˆ°ç›¸åŒé‚®ç®±çš„ç°æœ‰ç”¨æˆ·æ•°æ®');
            return null;
        }
        

        

        

        
        async function loginUser(user) {
            console.log('=== ç”¨æˆ·ç™»å½• ===');
            console.log('ç™»å½•ç”¨æˆ·ä¿¡æ¯:', user);
            
            // ğŸš€ æ£€æŸ¥æ˜¯å¦æ­£åœ¨ç™»å‡ºï¼Œå¦‚æœæ˜¯åˆ™åœæ­¢ç™»å½•æµç¨‹
            if (isLoggingOut) {
                console.log('æ£€æµ‹åˆ°æ­£åœ¨ç™»å‡ºï¼Œåœæ­¢ç™»å½•æµç¨‹');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ç›¸åŒé‚®ç®±çš„ç”¨æˆ·æ•°æ®
            const existingUserData = checkExistingUserData(user.email);
            if (existingUserData) {
                console.log('æ‰¾åˆ°ç›¸åŒé‚®ç®±çš„ç°æœ‰ç”¨æˆ·æ•°æ®:', existingUserData);
                // åˆå¹¶ç”¨æˆ·æ•°æ®ï¼Œä¿æŒå†å²è®°å½•
                user = { ...existingUserData, ...user };
                console.log('åˆå¹¶åçš„ç”¨æˆ·æ•°æ®:', user);
            }
            
            // å¦‚æœä¹‹å‰æœ‰å…¶ä»–ç”¨æˆ·ç™»å½•ï¼Œå…ˆæ¸…ç†
            if (currentUser && currentUser.id !== user.id) {
                console.log('æ£€æµ‹åˆ°ä¸åŒç”¨æˆ·ç™»å½•ï¼Œæ¸…ç†ä¹‹å‰çš„æ•°æ®');
                // ä¿å­˜ä¹‹å‰ç”¨æˆ·çš„å†å²è®°å½•
                if (userHistory.length > 0) {
                    saveUserHistoryToStorage();
                    console.log('å·²ä¿å­˜ä¹‹å‰ç”¨æˆ·çš„å†å²è®°å½•');
                }
                // æ¸…ç©ºå½“å‰å†å²è®°å½•æ•°ç»„
                userHistory = [];
            }
            
            // è®¾ç½®æ–°ç”¨æˆ·
            currentUser = user;
            console.log('å½“å‰ç”¨æˆ·å·²è®¾ç½®ä¸º:', currentUser.id);
            
            // æ›´æ–°UIæ˜¾ç¤º
            updateLoginUI();
            
            // æ˜¾ç¤ºå†å²è®°å½•ä¸»æ ‡ç­¾é¡µ
            document.getElementById('history-main-tab').style.display = 'inline-block';
            
            // ğŸš€ ä¿®å¤ç«æ€æ¡ä»¶ï¼šç«‹å³ä¿å­˜ç™»å½•çŠ¶æ€åˆ°localStorage
            // åœ¨awaitè°ƒç”¨ä¹‹å‰ä¿å­˜ï¼Œé¿å…è¢«åç»­çš„ç™»å‡ºæ“ä½œè¦†ç›–
            localStorage.setItem('nanoBananaUser', JSON.stringify(user));
            console.log('ç™»å½•çŠ¶æ€å·²ç«‹å³ä¿å­˜åˆ°localStorage');
            
            // åŒæ­¥ç”¨æˆ·ä¿¡æ¯åˆ°Supabase
            if (supabase) {
                console.log('åŒæ­¥ç”¨æˆ·ä¿¡æ¯åˆ°Supabase...');
                await upsertUserToSupabase(user);
            }
            
            // åŠ è½½ç”¨æˆ·å†å²è®°å½•
            await loadUserHistory();
            
            // ğŸš€ ç™»å½•å®Œæˆï¼Œé‡ç½®ç™»å‡ºæ ‡å¿—
            isLoggingOut = false;
            console.log('ç™»å½•å®Œæˆï¼Œé‡ç½®ç™»å‡ºæ ‡å¿—');
            
            showSuccessMessage(`æ¬¢è¿å›æ¥ï¼Œ${user.name}ï¼`);
        }
        
                function googleLogout() {
            console.log('=== ç”¨æˆ·ç™»å‡º ===');
            
            // ğŸš€ è®¾ç½®ç™»å‡ºæ ‡å¿—ï¼Œé˜²æ­¢ç«æ€æ¡ä»¶
            isLoggingOut = true;
            console.log('è®¾ç½®ç™»å‡ºæ ‡å¿—ï¼Œé˜²æ­¢ç™»å½•æµç¨‹ç»§ç»­æ‰§è¡Œ');
            
            // åœ¨ç™»å‡ºå‰ä¿å­˜å½“å‰ç”¨æˆ·çš„å†å²è®°å½•
            if (currentUser && userHistory.length > 0) {
                console.log('ç™»å‡ºå‰ä¿å­˜å†å²è®°å½•ï¼Œç”¨æˆ·ID:', currentUser.id);
                saveUserHistoryToStorage();
                console.log('å·²ä¿å­˜å†å²è®°å½•');
            }
            
            // æ¸…ç†æ‰€æœ‰ç”¨æˆ·ç›¸å…³æ•°æ®
            const oldUserId = currentUser ? currentUser.id : null;
            currentUser = null;
            userHistory = [];
            
            console.log('ç”¨æˆ·æ•°æ®å·²æ¸…ç†ï¼Œæ—§ç”¨æˆ·ID:', oldUserId);
            
            // æ›´æ–°UIæ˜¾ç¤º
            updateLoginUI();
            
            // éšè—å†å²è®°å½•ä¸»æ ‡ç­¾é¡µ
            document.getElementById('history-main-tab').style.display = 'none';
            
            // æ¸…é™¤localStorageä¸­çš„ç”¨æˆ·ä¿¡æ¯
            localStorage.removeItem('nanoBananaUser');
            
            // å¦‚æœå½“å‰åœ¨å†å²è®°å½•æ ‡ç­¾é¡µï¼Œåˆ‡æ¢åˆ°Editoræ ‡ç­¾é¡µ
            if (document.getElementById('history-tab').classList.contains('active')) {
                switchMainTab('editor');
            }
            
            // æ¸…ç©ºå†å²è®°å½•æ˜¾ç¤º
            const historyList = document.getElementById('history-list');
            if (historyList) {
                historyList.innerHTML = '<div class="history-placeholder"><p>è¯·å…ˆç™»å½•æŸ¥çœ‹å†å²è®°å½•</p></div>';
            }
            
            // æ¸…ç†ç•Œé¢ï¼šæ¸…ç©ºæ‰€æœ‰è¾“å…¥å’Œæ˜¾ç¤ºå†…å®¹
            clearAllInterfaceData();
            
            showSuccessMessage('å·²æˆåŠŸç™»å‡º');
        }
        
        // æ¸…ç†ç•Œé¢æ•°æ®
        function clearAllInterfaceData() {
            console.log('æ¸…ç†ç•Œé¢æ•°æ®...');
            
            // æ¸…ç©ºæ–‡æœ¬æç¤ºè¯
            const textPrompt = document.getElementById('text-prompt');
            if (textPrompt) {
                textPrompt.value = '';
                console.log('å·²æ¸…ç©ºæ–‡æœ¬æç¤ºè¯');
            }
            
            const multiPrompt = document.getElementById('multi-prompt');
            if (multiPrompt) {
                multiPrompt.value = '';
                console.log('å·²æ¸…ç©ºå¤šå›¾æç¤ºè¯');
            }
            
            // æ¸…ç©ºå›¾åƒé€‰æ‹©
            selectedFile = null;
            selectedMultiFiles = [];
            currentImageData = null;
            console.log('å·²æ¸…ç©ºå›¾åƒé€‰æ‹©');
            
            // æ¸…ç©ºå›¾åƒé¢„è§ˆ
            const imagePreview = document.getElementById('image-preview');
            if (imagePreview) {
                imagePreview.style.display = 'none';
                imagePreview.innerHTML = '';
                console.log('å·²æ¸…ç©ºå•å›¾é¢„è§ˆ');
            }
            
            const multiImagePreview = document.getElementById('multi-image-preview');
            if (multiImagePreview) {
                multiImagePreview.style.display = 'none';
                const multiPreviewImages = document.getElementById('multi-preview-images');
                if (multiPreviewImages) {
                    multiPreviewImages.innerHTML = '';
                }
                const imageCount = document.getElementById('image-count');
                if (imageCount) {
                    imageCount.textContent = '0';
                }
                console.log('å·²æ¸…ç©ºå¤šå›¾é¢„è§ˆ');
            }
            
            // æ¸…ç©ºç»“æœæ˜¾ç¤º
            const resultImage = document.getElementById('result-image');
            if (resultImage) {
                resultImage.src = '';
                console.log('å·²æ¸…ç©ºç»“æœå›¾åƒ');
            }
            
            // éšè—ç»“æœåŒºåŸŸï¼Œæ˜¾ç¤ºåˆå§‹å ä½ç¬¦
            const resultSection = document.querySelector('.result');
            const initialPlaceholder = document.getElementById('initial-placeholder');
            if (resultSection && initialPlaceholder) {
                resultSection.style.display = 'none';
                initialPlaceholder.style.display = 'block';
                console.log('å·²æ˜¾ç¤ºåˆå§‹å ä½ç¬¦');
            }
            
            // éšè—é”™è¯¯çŠ¶æ€
            const errorSection = document.querySelector('.error');
            if (errorSection) {
                errorSection.style.display = 'none';
                console.log('å·²éšè—é”™è¯¯çŠ¶æ€');
            }
            
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            const fileInput = document.getElementById('image-input');
            if (fileInput) {
                fileInput.value = '';
                console.log('å·²é‡ç½®å•å›¾æ–‡ä»¶è¾“å…¥');
            }
            
            const multiFileInput = document.getElementById('multi-images');
            if (multiFileInput) {
                multiFileInput.value = '';
                console.log('å·²é‡ç½®å¤šå›¾æ–‡ä»¶è¾“å…¥');
            }
            
            // å¼ºåˆ¶åˆ·æ–°ç•Œé¢çŠ¶æ€
            setTimeout(() => {
                // ç¡®ä¿æ‰€æœ‰çŠ¶æ€éƒ½å·²æ›´æ–°
                console.log('å»¶è¿Ÿæ£€æŸ¥ç•Œé¢çŠ¶æ€...');
                
                // å†æ¬¡æ£€æŸ¥å…³é”®å…ƒç´ çŠ¶æ€
                if (textPrompt && textPrompt.value !== '') {
                    console.log('è­¦å‘Šï¼šæ–‡æœ¬æç¤ºè¯ä»æœªæ¸…ç©ºï¼Œå¼ºåˆ¶æ¸…ç©º');
                    textPrompt.value = '';
                }
                
                if (multiPrompt && multiPrompt.value !== '') {
                    console.log('è­¦å‘Šï¼šå¤šå›¾æç¤ºè¯ä»æœªæ¸…ç©ºï¼Œå¼ºåˆ¶æ¸…ç©º');
                    multiPrompt.value = '';
                }
                
                if (selectedMultiFiles.length > 0) {
                    console.log('è­¦å‘Šï¼šå¤šå›¾é€‰æ‹©ä»æœªæ¸…ç©ºï¼Œå¼ºåˆ¶æ¸…ç©º');
                    selectedMultiFiles = [];
                }
                
                console.log('ç•Œé¢æ•°æ®æ¸…ç†å®Œæˆ');
            }, 100);
        }
        
        function updateLoginUI() {
            const loginSection = document.getElementById('login-section');
            const userInfo = document.getElementById('user-info');
            
            if (currentUser) {
                loginSection.style.display = 'none';
                userInfo.style.display = 'flex';
                
                // ä¼˜å…ˆä½¿ç”¨Googleå¤´åƒï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å¤´åƒ
                const avatarUrl = currentUser.picture || currentUser.avatar || 'https://lh3.googleusercontent.com/a/default-user';
                document.getElementById('user-avatar-img').src = avatarUrl;
                document.getElementById('user-name').textContent = currentUser.name || 'Googleç”¨æˆ·';
                document.getElementById('user-avatar-img').alt = (currentUser.name || 'Googleç”¨æˆ·') + 'çš„å¤´åƒ';
                document.getElementById('user-email').textContent = currentUser.email || 'æœªçŸ¥é‚®ç®±';
                
                console.log('ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°:', {
                    name: currentUser.name,
                    email: currentUser.email,
                    avatar: avatarUrl
                });
                
                // ç™»å½•æˆåŠŸåè‡ªåŠ¨åŠ è½½å†å²è®°å½•
                loadUserHistory();
            } else {
                loginSection.style.display = 'block';
                userInfo.style.display = 'none';
            }
        }
        
        // å†å²è®°å½•ç›¸å…³å‡½æ•°
        async function loadUserHistory() {
            if (!currentUser) {
                return;
            }
            
            // è®¾ç½®åŒæ­¥çŠ¶æ€
            window.isHistorySyncing = true;
            
            // å…ˆå°è¯•ä»localStorageå¿«é€ŸåŠ è½½ï¼ˆç”¨æˆ·ä½“éªŒä¼˜å…ˆï¼‰
            const hasLocalHistory = loadUserHistoryFromStorage();
            if (hasLocalHistory && userHistory.length > 0) {
                renderHistory();
                console.log('å¿«é€ŸåŠ è½½ï¼šä»localStorageåŠ è½½å†å²è®°å½•ï¼Œå…±', userHistory.length, 'æ¡');
            }
            
            // åå°ä»SupabaseåŒæ­¥æœ€æ–°æ•°æ®ï¼ˆä¸é˜»å¡UIï¼‰
            if (supabase) {
                await loadHistoryFromSupabaseBackground();
            }
            
            // åŒæ­¥å®Œæˆï¼Œæ¸…é™¤çŠ¶æ€
            window.isHistorySyncing = false;
            
            // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            renderHistory();
        }
        
        // åå°åŠ è½½Supabaseæ•°æ®ï¼Œä¸é˜»å¡UI
        async function loadHistoryFromSupabaseBackground() {
            // æ˜¾ç¤ºåå°åŒæ­¥çŠ¶æ€
            showHistorySyncStatus();
            
            try {
                const { data, error } = await supabase
                    .from('history')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(50); // é™åˆ¶åŠ è½½æ•°é‡ï¼Œæå‡æ€§èƒ½
                
                if (error) {
                    console.error('SupabaseåŠ è½½å¤±è´¥:', error);
                    hideHistorySyncStatus();
                    return;
                }
                
                if (data && data.length > 0) {
                    // è½¬æ¢æ•°æ®æ ¼å¼
                    const newHistory = data.map(item => ({
                        id: String(item.id),
                        type: item.type,
                        prompt: item.prompt,
                        resultImage: item.result_image,
                        inputImages: item.input_images || [],
                        createdAt: item.created_at
                    }));
                    
                    // æ›´æ–°æœ¬åœ°æ•°æ®
                    userHistory = newHistory;
                    saveUserHistoryToStorage();
                    
                    // é‡æ–°æ¸²æŸ“ï¼ˆå¦‚æœç”¨æˆ·å½“å‰åœ¨Historyé¡µé¢ï¼‰
                    const historyTab = document.querySelector('.main-tab-button[onclick*="history"]');
                    if (historyTab && historyTab.classList.contains('active')) {
                        renderHistory();
                        console.log('åå°åŒæ­¥ï¼šSupabaseæ•°æ®å·²æ›´æ–°ï¼Œå…±', userHistory.length, 'æ¡');
                    }
                }
                
                hideHistorySyncStatus();
            } catch (error) {
                console.error('åå°åŒæ­¥å¤±è´¥:', error);
                hideHistorySyncStatus();
            }
        }
        
        // æ˜¾ç¤ºå†å²è®°å½•åŒæ­¥çŠ¶æ€
        function showHistorySyncStatus() {
            const historyList = document.getElementById('history-list');
            if (historyList && userHistory.length > 0) {
                const syncStatus = document.createElement('div');
                syncStatus.id = 'history-sync-status';
                syncStatus.className = 'history-sync-status';
                syncStatus.innerHTML = '<div class="sync-spinner"></div><small>æ­£åœ¨åŒæ­¥æœ€æ–°æ•°æ®...</small>';
                historyList.appendChild(syncStatus);
            }
        }
        
        // éšè—å†å²è®°å½•åŒæ­¥çŠ¶æ€
        function hideHistorySyncStatus() {
            const syncStatus = document.getElementById('history-sync-status');
            if (syncStatus) {
                syncStatus.remove();
            }
        }
        
        function renderHistory(historyToRender = null) {
            const historyList = document.getElementById('history-list');
            if (!historyList) {
                console.error('æ‰¾ä¸åˆ°history-listå…ƒç´ ');
                return;
            }
            
            if (!currentUser) {
                historyList.innerHTML = '<div class="history-placeholder"><p>è¯·å…ˆç™»å½•æŸ¥çœ‹å†å²è®°å½•</p></div>';
                return;
            }
            
            // ä½¿ç”¨ä¼ å…¥çš„å†å²è®°å½•æˆ–é»˜è®¤çš„userHistory
            const historyData = historyToRender || userHistory;
            
            if (!historyData || historyData.length === 0) {
                historyList.innerHTML = '<div class="history-placeholder"><p>æš‚æ— ç”Ÿæˆå†å²è®°å½•</p><small>ç”Ÿæˆå›¾åƒåï¼Œå†å²è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</small></div>';
                return;
            }
            
            const historyHTML = historyData.map(item => {
                return `
                <div class="history-item">
                    <img src="${item.resultImage}" alt="ç”Ÿæˆç»“æœ" class="history-item-image" onclick="showImageModal('${item.resultImage}')">
                    <div class="history-item-details">
                        <span class="history-item-type">${item.type === 'text-to-image' ? 'æ–‡æœ¬ç”Ÿæˆå›¾åƒ' : 'å›¾åƒç¼–è¾‘'}</span>
                        <div class="history-item-prompt">${item.prompt}</div>
                        <div class="history-item-date">${new Date(item.createdAt).toLocaleString()}</div>
                        <div class="history-item-actions">
                            <button class="history-action-btn history-download-btn" onclick="downloadHistoryImage('${item.resultImage}')">ä¸‹è½½</button>
                            <button class="history-action-btn history-reference-btn" onclick="referenceHistoryImage('${item.id}')">å¼•ç”¨</button>
                            <button class="history-action-btn history-delete-btn" onclick="deleteHistoryItem('${item.id}')" title="åˆ é™¤æ­¤è®°å½•">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
            historyList.innerHTML = historyHTML;
            
            // æ˜¾ç¤ºè®°å½•æ•°é‡
            const totalCount = userHistory.length;
            const filteredCount = historyData.length;
            if (totalCount !== filteredCount) {
                const countInfo = document.createElement('div');
                countInfo.className = 'history-count-info';
                countInfo.innerHTML = `<small>æ˜¾ç¤º ${filteredCount} æ¡è®°å½•ï¼Œå…± ${totalCount} æ¡</small>`;
                historyList.appendChild(countInfo);
            }
        }
        
        function downloadHistoryImage(imageSrc) {
            downloadImageFromSrc(imageSrc);
        }
        
        function referenceHistoryImage(historyId) {
            console.log('=== å¼•ç”¨å†å²è®°å½•è°ƒè¯•ä¿¡æ¯ ===');
            console.log('è¦å¼•ç”¨çš„historyId:', historyId);
            console.log('å½“å‰userHistoryæ•°ç»„:', userHistory);
            console.log('userHistoryé•¿åº¦:', userHistory ? userHistory.length : 'undefined');
            console.log('å½“å‰ç”¨æˆ·:', currentUser);
            
            let historyItem = null;
            
            // é¦–å…ˆå°è¯•åœ¨userHistoryæ•°ç»„ä¸­æŸ¥æ‰¾
            if (userHistory && userHistory.length > 0) {
                // æ˜¾ç¤ºæ‰€æœ‰å†å²è®°å½•é¡¹çš„IDï¼Œå¸®åŠ©è°ƒè¯•
                console.log('userHistoryä¸­æ‰€æœ‰é¡¹çš„ID:');
                userHistory.forEach((item, index) => {
                    console.log(`  [${index}] ID: "${item.id}", ç±»å‹: ${typeof item.id}`);
                });
                
                historyItem = userHistory.find(item => {
                    const match = item.id === historyId;
                    console.log(`æ¯”è¾ƒ: "${item.id}" === "${historyId}" => ${match}`);
                    return match;
                });
                
                if (historyItem) {
                    console.log('åœ¨userHistoryæ•°ç»„ä¸­æ‰¾åˆ°å†å²è®°å½•');
                }
            } else {
                console.log('userHistoryæ•°ç»„ä¸ºç©ºæˆ–æœªå®šä¹‰ï¼Œå°è¯•é‡æ–°åŠ è½½...');
                // å°è¯•é‡æ–°åŠ è½½å†å²è®°å½•
                loadUserHistoryFromStorage();
                if (userHistory && userHistory.length > 0) {
                    console.log('é‡æ–°åŠ è½½åuserHistoryé•¿åº¦:', userHistory.length);
                    // å†æ¬¡å°è¯•æŸ¥æ‰¾
                    historyItem = userHistory.find(item => item.id === historyId);
                    if (historyItem) {
                        console.log('é‡æ–°åŠ è½½ååœ¨userHistoryä¸­æ‰¾åˆ°å†å²è®°å½•');
                    }
                }
            }
            
            // å¦‚æœåœ¨userHistoryä¸­æ²¡æ‰¾åˆ°ï¼Œå°è¯•åœ¨localStorageä¸­æŸ¥æ‰¾
            if (!historyItem) {
                console.log('åœ¨userHistoryä¸­æœªæ‰¾åˆ°ï¼Œå°è¯•åœ¨localStorageä¸­æŸ¥æ‰¾...');
                historyItem = findHistoryInLocalStorage(historyId);
                
                if (historyItem) {
                    console.log('åœ¨localStorageä¸­æ‰¾åˆ°å†å²è®°å½•:', historyItem);
                } else {
                    console.error('æ‰€æœ‰æŸ¥æ‰¾æ–¹å¼éƒ½å¤±è´¥äº†');
                    console.error('å¯èƒ½çš„åŸå› :');
                    console.error('1. historyIdç±»å‹ä¸åŒ¹é…');
                    console.error('2. userHistoryæ•°ç»„ä¸ºç©ºæˆ–æœªå®šä¹‰');
                    console.error('3. å†å²è®°å½•é¡¹çš„IDæ ¼å¼ä¸ä¸€è‡´');
                    console.error('4. æ•°æ®å·²ä»localStorageä¸­æ¸…é™¤');
                    showError('æœªæ‰¾åˆ°è¦å¼•ç”¨çš„å†å²è®°å½•ï¼Œè¯·æ£€æŸ¥æ•°æ®æˆ–åˆ·æ–°é¡µé¢');
                    return;
                }
            }
            
            console.log('å¼•ç”¨å†å²è®°å½•:', historyItem);
            
            // åˆ‡æ¢åˆ°Editoræ ‡ç­¾é¡µçš„å›¾åƒç¼–è¾‘åŠŸèƒ½
            switchMainTab('editor');
            switchEditorTab('multi-image');
            
            // æ¸…ç©ºå½“å‰é€‰æ‹©
            selectedMultiFiles = [];
            
            // åªå¼•ç”¨ç»“æœå›¾åƒï¼Œä¸å¼•ç”¨åŸå§‹è¾“å…¥å›¾åƒ
            if (historyItem.resultImage) {
                try {
                    // å°†base64è½¬æ¢ä¸ºFileå¯¹è±¡
                    const base64Data = historyItem.resultImage.split(',')[1];
                    const byteCharacters = atob(base64Data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteNumbers.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'image/png' });
                    const file = new File([blob], `referenced_result_${Date.now()}.png`, { type: 'image/png' });
                    
                    selectedMultiFiles.push(file);
                    console.log('å·²æ·»åŠ ç»“æœå›¾åƒä½œä¸ºè¾“å…¥:', file.name);
                } catch (error) {
                    console.error('è½¬æ¢ç»“æœå›¾åƒå¤±è´¥:', error);
                    showError('å¼•ç”¨å›¾åƒå¤±è´¥ï¼Œè¯·é‡è¯•');
                    return;
                }
            }
            
            // ä¸å†æ·»åŠ åŸå§‹è¾“å…¥å›¾åƒï¼Œåªå¼•ç”¨ç»“æœå›¾åƒ
            console.log('å¼•ç”¨ç­–ç•¥ï¼šåªå¼•ç”¨ç»“æœå›¾åƒï¼Œä¸å¼•ç”¨åŸå§‹è¾“å…¥å›¾åƒ');
            
            // ä¸å¡«å……æç¤ºè¯ï¼Œè®©ç”¨æˆ·è‡ªå·±è¾“å…¥
            console.log('å¼•ç”¨ç­–ç•¥ï¼šåªå¼•ç”¨å›¾åƒï¼Œä¸å¡«å……æç¤ºè¯ï¼Œç”¨æˆ·éœ€è¦è‡ªå·±è¾“å…¥');
            
            // æ›´æ–°é¢„è§ˆ
            updateMultiImagePreview();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            const imageCount = selectedMultiFiles.length;
            showSuccessMessage(`å·²å¼•ç”¨å†å²è®°å½•ï¼Œå…±${imageCount}å¼ å›¾åƒï¼Œæ‚¨å¯ä»¥ç»§ç»­ç¼–è¾‘æˆ–ç”Ÿæˆæ–°å›¾åƒ`);
            
            console.log('å¼•ç”¨å®Œæˆï¼Œå½“å‰é€‰æ‹©çš„å›¾åƒæ•°é‡:', selectedMultiFiles.length);
        }
        
        // åœ¨localStorageä¸­æŸ¥æ‰¾å†å²è®°å½•
        function findHistoryInLocalStorage(historyId) {
            console.log('å°è¯•åœ¨localStorageä¸­æŸ¥æ‰¾å†å²è®°å½•:', historyId);
            
            if (!currentUser) {
                console.log('æ²¡æœ‰å½“å‰ç”¨æˆ·ï¼Œæ— æ³•æŸ¥æ‰¾localStorage');
                return null;
            }
            
            console.log('å½“å‰ç”¨æˆ·ID:', currentUser.id);
            console.log('localStorageæ€»é”®æ•°:', localStorage.length);
            
            // ä¼˜å…ˆæŸ¥æ‰¾å½“å‰ç”¨æˆ·çš„å†å²è®°å½•é”®
            const currentUserKey = `nanoBananaHistory_${currentUser.id}`;
            console.log('å½“å‰ç”¨æˆ·çš„å†å²è®°å½•é”®:', currentUserKey);
            
            // é¦–å…ˆå°è¯•ä»å½“å‰ç”¨æˆ·çš„é”®ä¸­æŸ¥æ‰¾
            try {
                const currentUserHistory = localStorage.getItem(currentUserKey);
                if (currentUserHistory) {
                    const history = JSON.parse(currentUserHistory);
                    console.log(`å½“å‰ç”¨æˆ·é”®åŒ…å« ${history.length} æ¡å†å²è®°å½•`);
                    
                    if (history.length > 0) {
                        console.log('å‰3æ¡è®°å½•çš„ID:');
                        history.slice(0, 3).forEach((item, index) => {
                            console.log(`  [${index}] ID: "${item.id}", ç±»å‹: ${typeof item.id}`);
                        });
                        
                        const foundItem = history.find(item => {
                            const match = item.id === historyId;
                            console.log(`æ¯”è¾ƒå½“å‰ç”¨æˆ·é”®: "${item.id}" === "${historyId}" => ${match}`);
                            return match;
                        });
                        
                        if (foundItem) {
                            console.log('åœ¨å½“å‰ç”¨æˆ·é”®ä¸­æ‰¾åˆ°å†å²è®°å½•:', foundItem);
                            return foundItem;
                        }
                    }
                } else {
                    console.log('å½“å‰ç”¨æˆ·é”®ä¸­æ²¡æœ‰å†å²è®°å½•æ•°æ®');
                }
            } catch (error) {
                console.error('è§£æå½“å‰ç”¨æˆ·å†å²è®°å½•å¤±è´¥:', error);
            }
            
            // å¦‚æœå½“å‰ç”¨æˆ·é”®ä¸­æ²¡æ‰¾åˆ°ï¼Œéå†æ‰€æœ‰å†å²è®°å½•é”®ï¼ˆç”¨äºè°ƒè¯•ï¼‰
            console.log('åœ¨å½“å‰ç”¨æˆ·é”®ä¸­æœªæ‰¾åˆ°ï¼Œæ£€æŸ¥æ‰€æœ‰å†å²è®°å½•é”®...');
            const historyKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.includes('nanoBananaHistory')) {
                    historyKeys.push(key);
                    console.log('æ‰¾åˆ°å†å²è®°å½•é”®:', key);
                }
            }
            
            console.log('æ‰€æœ‰å†å²è®°å½•é”®:', historyKeys);
            
            // éå†æ¯ä¸ªå†å²è®°å½•é”®ï¼ˆä»…ç”¨äºè°ƒè¯•ï¼Œä¸è¿”å›å…¶ä»–ç”¨æˆ·çš„æ•°æ®ï¼‰
            for (const key of historyKeys) {
                if (key === currentUserKey) continue; // è·³è¿‡å½“å‰ç”¨æˆ·é”®
                
                try {
                    const historyData = localStorage.getItem(key);
                    if (historyData) {
                        const history = JSON.parse(historyData);
                        console.log(`é”® ${key} åŒ…å« ${history.length} æ¡å†å²è®°å½•ï¼ˆå…¶ä»–ç”¨æˆ·ï¼‰`);
                        
                        // æ˜¾ç¤ºå‰å‡ æ¡è®°å½•çš„IDç”¨äºè°ƒè¯•
                        if (history.length > 0) {
                            console.log('å‰3æ¡è®°å½•çš„ID:');
                            history.slice(0, 3).forEach((item, index) => {
                                console.log(`  [${index}] ID: "${item.id}", ç±»å‹: ${typeof item.id}`);
                            });
                        }
                        
                        // åœ¨å†å²è®°å½•ä¸­æŸ¥æ‰¾åŒ¹é…çš„IDï¼ˆä»…ç”¨äºè°ƒè¯•ï¼‰
                        const foundItem = history.find(item => {
                            const match = item.id === historyId;
                            console.log(`æ¯”è¾ƒé”® ${key}: "${item.id}" === "${historyId}" => ${match}`);
                            return match;
                        });
                        
                        if (foundItem) {
                            console.log('åœ¨å…¶ä»–ç”¨æˆ·é”®ä¸­æ‰¾åˆ°åŒ¹é…çš„å†å²è®°å½•ï¼ˆæ•°æ®éš”ç¦»é—®é¢˜ï¼‰:', foundItem);
                            console.log('âš ï¸ è­¦å‘Šï¼šè¿™å¯èƒ½è¡¨æ˜æ•°æ®éš”ç¦»æœ‰é—®é¢˜');
                            // ä¸è¿”å›å…¶ä»–ç”¨æˆ·çš„æ•°æ®ï¼Œä¿æŒæ•°æ®éš”ç¦»
                        }
                    }
                } catch (error) {
                    console.error('è§£ælocalStorageé”®', key, 'å¤±è´¥:', error);
                }
            }
            
            console.log('åœ¨localStorageä¸­æœªæ‰¾åˆ°åŒ¹é…çš„å†å²è®°å½•');
            return null;
        }
        
        function filterHistory() {
            const filterType = document.getElementById('history-type-filter').value;
            const searchTerm = document.getElementById('history-search').value.toLowerCase();
            
            let filteredHistory = userHistory;
            
            // æŒ‰ç±»å‹è¿‡æ»¤
            if (filterType) {
                filteredHistory = filteredHistory.filter(item => item.type === filterType);
            }
            
            // æŒ‰æœç´¢è¯è¿‡æ»¤
            if (searchTerm) {
                filteredHistory = filteredHistory.filter(item => 
                    item.prompt.toLowerCase().includes(searchTerm)
                );
            }
            
            renderHistory(filteredHistory);
        }
        
        function searchHistory() {
            // æœç´¢æ—¶è‡ªåŠ¨è§¦å‘è¿‡æ»¤
            filterHistory();
        }
        
        // ä¿å­˜ç”Ÿæˆå†å²
        async function saveToHistory(type, prompt, inputImages, resultImage) {
            console.log('saveToHistory è¢«è°ƒç”¨:', { type, prompt, inputImages, resultImage });
            console.log('å½“å‰ç”¨æˆ·:', currentUser);
            console.log('å½“å‰userHistoryé•¿åº¦:', userHistory ? userHistory.length : 'undefined');
            
            if (!currentUser) {
                console.log('saveToHistory: æ²¡æœ‰å½“å‰ç”¨æˆ·ï¼Œæ— æ³•ä¿å­˜');
                return;
            }
            
            const historyItem = {
                id: 'hist_' + Date.now(),
                type: type,
                prompt: prompt,
                resultImage: resultImage,
                createdAt: new Date().toISOString(),
                inputImages: inputImages || []
            };
            
            console.log('åˆ›å»ºçš„å†å²è®°å½•é¡¹:', historyItem);
            
            userHistory.unshift(historyItem); // æ·»åŠ åˆ°å¼€å¤´
            console.log('æ·»åŠ åˆ°userHistoryåï¼Œé•¿åº¦å˜ä¸º:', userHistory.length);
            
            // ä¿å­˜åˆ°localStorageï¼Œç¡®ä¿æ•°æ®æŒä¹…åŒ–
            saveUserHistoryToStorage();
            
            // åŒæ—¶ä¿å­˜åˆ°Supabase
            if (supabase) {
                console.log('åŒæ­¥å†å²è®°å½•åˆ°Supabase...');
                try {
                    const supabaseSuccess = await saveHistoryToSupabase(historyItem);
                    if (supabaseSuccess) {
                        console.log('å†å²è®°å½•å·²åŒæ­¥åˆ°Supabase');
                    } else {
                        console.warn('å†å²è®°å½•åŒæ­¥åˆ°Supabaseå¤±è´¥ï¼Œä½†å·²ä¿å­˜åˆ°localStorage');
                    }
                } catch (error) {
                    console.error('SupabaseåŒæ­¥é”™è¯¯:', error);
                }
            }
            
            console.log('ä¿å­˜å†å²è®°å½•å®Œæˆ:', historyItem);
            
            // æ›´æ–°æ˜¾ç¤º
            renderHistory();
        }
        
        // ä¿å­˜ç”¨æˆ·å†å²è®°å½•åˆ°localStorage
        function saveUserHistoryToStorage() {
            if (!currentUser) {
                console.log('saveUserHistoryToStorage: æ²¡æœ‰å½“å‰ç”¨æˆ·');
                return;
            }
            
            if (!userHistory) {
                console.log('saveUserHistoryToStorage: æ²¡æœ‰å†å²è®°å½•æ•°æ®');
                return;
            }
            
            const storageKey = `nanoBananaHistory_${currentUser.id}`;
            console.log('saveUserHistoryToStorage: ä¿å­˜åˆ°å­˜å‚¨é”®:', storageKey);
            console.log('saveUserHistoryToStorage: å½“å‰ç”¨æˆ·ID:', currentUser.id);
            console.log('saveUserHistoryToStorage: ä¿å­˜çš„å†å²è®°å½•æ•°é‡:', userHistory.length);
            
            try {
                localStorage.setItem(storageKey, JSON.stringify(userHistory));
                console.log('saveUserHistoryToStorage: å†å²è®°å½•å·²æˆåŠŸä¿å­˜åˆ°localStorage');
                
                // éªŒè¯ä¿å­˜æ˜¯å¦æˆåŠŸ
                const savedData = localStorage.getItem(storageKey);
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    console.log('saveUserHistoryToStorage: éªŒè¯ä¿å­˜æˆåŠŸï¼Œå­˜å‚¨çš„æ•°æ®æ•°é‡:', parsedData.length);
                    
                    // åˆ—å‡ºæ‰€æœ‰ç›¸å…³çš„localStorageé”®
                    console.log('saveUserHistoryToStorage: å½“å‰localStorageä¸­çš„æ‰€æœ‰é”®:');
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.includes('nanoBananaHistory')) {
                            console.log('  -', key);
                        }
                    }
                } else {
                    console.error('saveUserHistoryToStorage: éªŒè¯å¤±è´¥ï¼Œå­˜å‚¨åæ— æ³•è¯»å–æ•°æ®');
                }
            } catch (error) {
                console.error('saveUserHistoryToStorage: ä¿å­˜å†å²è®°å½•åˆ°localStorageå¤±è´¥:', error);
            }
        }
        
        // ä»localStorageåŠ è½½ç”¨æˆ·å†å²è®°å½•
        function loadUserHistoryFromStorage() {
            if (!currentUser) {
                console.log('loadUserHistoryFromStorage: æ²¡æœ‰å½“å‰ç”¨æˆ·');
                return false;
            }
            
            const storageKey = `nanoBananaHistory_${currentUser.id}`;
            console.log('loadUserHistoryFromStorage: å°è¯•åŠ è½½å­˜å‚¨é”®:', storageKey);
            console.log('loadUserHistoryFromStorage: å½“å‰ç”¨æˆ·ID:', currentUser.id);
            
            // åˆ—å‡ºæ‰€æœ‰ç›¸å…³çš„localStorageé”®ï¼Œå¸®åŠ©è°ƒè¯•
            console.log('loadUserHistoryFromStorage: å½“å‰localStorageä¸­çš„æ‰€æœ‰ç›¸å…³é”®:');
            let foundKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.includes('nanoBananaHistory')) {
                    foundKeys.push(key);
                    console.log('  -', key);
                }
            }
            
            if (foundKeys.length === 0) {
                console.log('loadUserHistoryFromStorage: æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å†å²è®°å½•ç›¸å…³çš„å­˜å‚¨é”®');
            }
            
            try {
                const savedHistory = localStorage.getItem(storageKey);
                console.log('loadUserHistoryFromStorage: localStorageä¸­çš„åŸå§‹æ•°æ®:', savedHistory ? 'æœ‰æ•°æ®' : 'æ— æ•°æ®');
                
                if (savedHistory) {
                    userHistory = JSON.parse(savedHistory);
                    console.log('loadUserHistoryFromStorage: æˆåŠŸè§£æå†å²è®°å½•ï¼Œå…±', userHistory.length, 'æ¡');
                    return true;
                } else {
                    console.log('loadUserHistoryFromStorage: æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„å†å²è®°å½•');
                    console.log('loadUserHistoryFromStorage: å¯èƒ½çš„åŸå› ï¼šå­˜å‚¨é”®ä¸åŒ¹é…æˆ–æ•°æ®å·²è¢«æ¸…é™¤');
                }
            } catch (error) {
                console.error('loadUserHistoryFromStorage: è§£æå†å²è®°å½•å¤±è´¥:', error);
            }
            
            return false;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded successfully');
            console.log('Available functions:', typeof switchTab, typeof generateFromText);
            
            // æ£€æŸ¥Google OAuthé…ç½®
            if (GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') {
                console.warn('âš ï¸ Google OAuth Client ID æœªé…ç½®ï¼');
                console.warn('è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤é…ç½®ï¼š');
                console.warn('1. è®¿é—® https://console.cloud.google.com/');
                console.warn('2. åˆ›å»ºé¡¹ç›®æˆ–é€‰æ‹©ç°æœ‰é¡¹ç›®');
                console.warn('3. å¯ç”¨ Google+ API å’Œ Google OAuth2 API');
                console.warn('4. åœ¨"å‡­æ®"é¡µé¢åˆ›å»ºOAuth 2.0å®¢æˆ·ç«¯ID');
                console.warn('5. è®¾ç½®æˆæƒåŸŸåï¼ˆåŒ…æ‹¬ä½ çš„å¼€å‘åŸŸåï¼‰');
                console.warn('6. å°†è·å¾—çš„å®¢æˆ·ç«¯IDæ›¿æ¢ä»£ç ä¸­çš„ YOUR_GOOGLE_CLIENT_ID');
                console.warn('');
                console.warn('ğŸš€ Verceléƒ¨ç½²é…ç½®ï¼š');
                console.warn('æˆæƒJavaScriptæ¥æº: https://nano-banana-tool.vercel.app');
                console.warn('æˆæƒé‡å®šå‘URI: https://nano-banana-tool.vercel.app/oauth-callback.html');
                console.warn('âš ï¸ æ³¨æ„ï¼šJavaScriptæ¥æºä¸è¦åŒ…å«ç»“å°¾æ–œæ æˆ–è·¯å¾„ï¼');
                
                // æ˜¾ç¤ºé…ç½®æç¤º
                const configWarning = document.createElement('div');
                configWarning.style.cssText = 'position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#fff3cd;color:#856404;padding:15px;border-radius:8px;border:1px solid #ffeaa7;z-index:10000;max-width:600px;text-align:center;';
                configWarning.innerHTML = `
                    <strong>âš ï¸ Googleç™»å½•æœªé…ç½®</strong><br>
                    è¯·å…ˆé…ç½®Google OAuthå®¢æˆ·ç«¯IDæ‰èƒ½ä½¿ç”¨ç™»å½•åŠŸèƒ½<br>
                    <small>è¯¦ç»†é…ç½®è¯´æ˜è¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—</small><br>
                    <small style="color:#e74c3c;">ğŸš€ Verceléƒ¨ç½²ï¼šJavaScriptæ¥æºä¸è¦åŒ…å«ç»“å°¾æ–œæ ï¼</small>
                `;
                document.body.appendChild(configWarning);
                
                // 5ç§’åè‡ªåŠ¨éšè—
                setTimeout(() => {
                    configWarning.style.display = 'none';
                }, 5000);
            } else {
                console.log('âœ… Google OAuth Client ID å·²é…ç½®');
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ç™»å½•çŠ¶æ€
            const savedUser = localStorage.getItem('nanoBananaUser');
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    console.log('æ£€æµ‹åˆ°ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯:', user);
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–ç”¨æˆ·çš„å†å²è®°å½•éœ€è¦æ¸…ç†
                    const currentHistoryKeys = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.includes('nanoBananaHistory') && !key.includes(user.id)) {
                            currentHistoryKeys.push(key);
                        }
                    }
                    
                    if (currentHistoryKeys.length > 0) {
                        console.log('æ£€æµ‹åˆ°å…¶ä»–ç”¨æˆ·çš„å†å²è®°å½•ï¼Œæ­£åœ¨æ¸…ç†...');
                        currentHistoryKeys.forEach(key => {
                            localStorage.removeItem(key);
                            console.log('å·²æ¸…ç†å†å²è®°å½•é”®:', key);
                        });
                    }
                    
                    // ç™»å½•ç”¨æˆ·
                    loginUser(user);
                    console.log('å·²æ¢å¤ç”¨æˆ·ç™»å½•çŠ¶æ€');
                    
                } catch (error) {
                    console.error('è§£æä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                    localStorage.removeItem('nanoBananaUser');
                }
            }
            
            // æµ‹è¯•ä¸»æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
            console.log('Testing main tab switching functionality...');
            const mainTabs = document.querySelectorAll('.main-tab-button');
            mainTabs.forEach((tab, index) => {
                console.log(`Main Tab ${index}:`, tab.textContent, 'onclick:', tab.onclick);
                // ç¡®ä¿onclickäº‹ä»¶æ­£ç¡®ç»‘å®š
                if (!tab.onclick) {
                    console.warn(`Main Tab ${index} has no onclick handler`);
                }
            });
            
            // æµ‹è¯•ç¼–è¾‘å™¨æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
            console.log('Testing editor tab switching functionality...');
            const editorTabs = document.querySelectorAll('.editor-tab-button');
            editorTabs.forEach((tab, index) => {
                console.log(`Editor Tab ${index}:`, tab.textContent, 'onclick:', tab.onclick);
                // ç¡®ä¿onclickäº‹ä»¶æ­£ç¡®ç»‘å®š
                if (!tab.onclick) {
                    console.warn(`Editor Tab ${index} has no onclick handler`);
                }
            });
            
            // æµ‹è¯•ç”ŸæˆæŒ‰é’®
            const generateButtons = document.querySelectorAll('.generate-btn');
            generateButtons.forEach((btn, index) => {
                console.log(`Generate button ${index}:`, btn.textContent, 'onclick:', btn.onclick);
            });
        });
        
        // ç«‹å³æ‰§è¡Œçš„æµ‹è¯•
        console.log('Script loaded, testing basic functionality...');
        // ç§»é™¤å¯èƒ½å¹²æ‰°çš„alertæµ‹è¯•
        console.log('JavaScript functions loaded successfully');



        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            // ç¦ç”¨æ‰€æœ‰ç”ŸæˆæŒ‰é’®
            document.querySelectorAll('.generate-btn').forEach(btn => {
                btn.disabled = true;
            });
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            // å¯ç”¨æ‰€æœ‰ç”ŸæˆæŒ‰é’®
            document.querySelectorAll('.generate-btn').forEach(btn => {
                btn.disabled = false;
            });
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.querySelector('.error').classList.add('show');
        }

        // æ˜¾ç¤ºåŠ è½½æ¶ˆæ¯
        function showLoadingMessage(message) {
            // åˆ›å»ºåŠ è½½æ¶ˆæ¯å…ƒç´ 
            let loadingDiv = document.getElementById('loading-message');
            if (!loadingDiv) {
                loadingDiv = document.createElement('div');
                loadingDiv.id = 'loading-message';
                loadingDiv.className = 'loading-message';
                loadingDiv.innerHTML = `
                    <div class="loading-spinner"></div>
                    <p>${message}</p>
                `;
                
                // æ’å…¥åˆ°é¡µé¢é¡¶éƒ¨
                document.body.insertBefore(loadingDiv, document.body.firstChild);
            } else {
                loadingDiv.innerHTML = `
                    <div class="loading-spinner"></div>
                    <p>${message}</p>
                `;
            }
            
            loadingDiv.classList.add('show');
        }
        
        // éšè—åŠ è½½æ¶ˆæ¯
        function hideLoadingMessage() {
            const loadingDiv = document.getElementById('loading-message');
            if (loadingDiv) {
                loadingDiv.classList.remove('show');
            }
        }
        
        // æ˜¾ç¤ºç”ŸæˆçŠ¶æ€æç¤º
        function showGenerationStatus(message) {
            // åœ¨å³ä¾§ç”ŸæˆåŒºåŸŸæ˜¾ç¤ºçŠ¶æ€æç¤º
            const resultSection = document.querySelector('.result');
            const initialPlaceholder = document.getElementById('initial-placeholder');
            
            // å…ˆéšè—å ä½ç¬¦
            if (initialPlaceholder) {
                initialPlaceholder.style.display = 'none';
            }
            
            if (resultSection) {
                // æ¸…ç©ºç»“æœåŒºåŸŸå¹¶æ˜¾ç¤ºçŠ¶æ€
                resultSection.innerHTML = `
                    <div class="generation-status-inline">
                        <div class="status-spinner"></div>
                        <p>${message}</p>
                    </div>
                `;
                resultSection.style.display = 'block';
                resultSection.classList.add('show');
                console.log('åœ¨ç»“æœåŒºåŸŸæ˜¾ç¤ºç”ŸæˆçŠ¶æ€:', message);
            }
        }
        
        // éšè—ç”ŸæˆçŠ¶æ€æç¤º
        function hideGenerationStatus() {
            // çŠ¶æ€æç¤ºä¼šåœ¨showResultæˆ–hideResultä¸­è‡ªåŠ¨å¤„ç†
            // è¿™é‡Œåªéœ€è¦è®°å½•æ—¥å¿—
            console.log('éšè—ç”ŸæˆçŠ¶æ€æç¤º');
        }
        

        
        // Supabaseç”¨æˆ·ç®¡ç†å‡½æ•°
        async function upsertUserToSupabase(user) {
            if (!supabase) {
                console.log('Supabaseæœªé…ç½®ï¼Œè·³è¿‡ç”¨æˆ·åŒæ­¥');
                return null;
            }
            
            try {
                const { data, error } = await supabase
                    .from('users')
                    .upsert({
                        id: user.id,
                        email: user.email,
                        name: user.name,
                        avatar_url: user.picture || user.avatar,
                        created_at: new Date().toISOString()
                    }, {
                        onConflict: 'id'
                    });
                
                if (error) {
                    console.error('ä¿å­˜ç”¨æˆ·åˆ°Supabaseå¤±è´¥:', error);
                    return null;
                }
                
                console.log('ç”¨æˆ·å·²åŒæ­¥åˆ°Supabase:', data);
                return data;
            } catch (error) {
                console.error('Supabaseç”¨æˆ·åŒæ­¥é”™è¯¯:', error);
                return null;
            }
        }
        
        // Supabaseå†å²è®°å½•ç®¡ç†å‡½æ•°
        async function saveHistoryToSupabase(historyItem) {
            if (!supabase || !currentUser) {
                console.log('Supabaseæœªé…ç½®æˆ–ç”¨æˆ·æœªç™»å½•ï¼Œè·³è¿‡å†å²è®°å½•åŒæ­¥');
                return false;
            }
            
            try {
                const { data, error } = await supabase
                    .from('history')
                    .insert({
                        user_id: currentUser.id,
                        type: historyItem.type,
                        prompt: historyItem.prompt,
                        result_image: historyItem.resultImage,
                        input_images: historyItem.inputImages,
                        created_at: historyItem.createdAt
                    });
                
                if (error) {
                    console.error('ä¿å­˜å†å²è®°å½•åˆ°Supabaseå¤±è´¥:', error);
                    return false;
                }
                
                console.log('å†å²è®°å½•å·²åŒæ­¥åˆ°Supabase:', data);
                return true;
            } catch (error) {
                console.error('Supabaseå†å²è®°å½•åŒæ­¥é”™è¯¯:', error);
                return false;
            }
        }
        
        async function loadHistoryFromSupabase() {
            if (!supabase || !currentUser) {
                console.log('Supabaseæœªé…ç½®æˆ–ç”¨æˆ·æœªç™»å½•ï¼Œè·³è¿‡å†å²è®°å½•åŠ è½½');
                return false;
            }
            
            try {
                console.log('ä»SupabaseåŠ è½½å†å²è®°å½•ï¼Œç”¨æˆ·ID:', currentUser.id);
                
                const { data, error } = await supabase
                    .from('history')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('ä»SupabaseåŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                    return false;
                }
                
                if (data && data.length > 0) {
                    console.log('Supabaseè¿”å›åŸå§‹æ•°æ®:', data);
                    
                    // è½¬æ¢Supabaseæ•°æ®æ ¼å¼ä¸ºæœ¬åœ°æ ¼å¼ï¼Œç¡®ä¿IDç±»å‹ä¸€è‡´
                    userHistory = data.map(item => {
                        // ç¡®ä¿IDæ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œä¸æœ¬åœ°ç”Ÿæˆçš„IDæ ¼å¼ä¿æŒä¸€è‡´
                        const convertedItem = {
                            id: String(item.id), // è½¬æ¢ä¸ºå­—ç¬¦ä¸²
                            type: item.type,
                            prompt: item.prompt,
                            resultImage: item.result_image,
                            inputImages: item.input_images || [],
                            createdAt: item.created_at
                        };
                        
                        console.log('è½¬æ¢åçš„å†å²è®°å½•é¡¹:', convertedItem);
                        return convertedItem;
                    });
                    
                    console.log('ä»SupabaseåŠ è½½å†å²è®°å½•æˆåŠŸï¼Œå…±', userHistory.length, 'æ¡');
                    console.log('è½¬æ¢åçš„userHistory:', userHistory);
                    return true;
                } else {
                    console.log('Supabaseä¸­æ²¡æœ‰æ‰¾åˆ°å†å²è®°å½•');
                    return false;
                }
            } catch (error) {
                console.error('Supabaseå†å²è®°å½•åŠ è½½é”™è¯¯:', error);
                return false;
            }
        }
        

        
        // åˆ é™¤å†å²è®°å½•é¡¹
        async function deleteHistoryItem(historyId) {
            if (!currentUser) {
                showError('è¯·å…ˆç™»å½•');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }
            
            try {
                console.log('=== åˆ é™¤å†å²è®°å½•è°ƒè¯•ä¿¡æ¯ ===');
                console.log('è¦åˆ é™¤çš„historyId:', historyId);
                console.log('å½“å‰userHistoryæ•°ç»„:', userHistory);
                console.log('userHistoryé•¿åº¦:', userHistory ? userHistory.length : 'undefined');
                
                if (userHistory && userHistory.length > 0) {
                    console.log('userHistoryä¸­æ‰€æœ‰é¡¹çš„ID:');
                    userHistory.forEach((item, index) => {
                        console.log(`  [${index}] ID: "${item.id}", ç±»å‹: ${typeof item.id}`);
                    });
                }
                
                // ä»Supabaseåˆ é™¤
                if (supabase) {
                    const { error } = await supabase
                        .from('history')
                        .delete()
                        .eq('id', historyId);
                    
                    if (error) {
                        console.error('ä»Supabaseåˆ é™¤å¤±è´¥:', error);
                        showError('åˆ é™¤å¤±è´¥ï¼š' + error.message);
                        return;
                    }
                    
                    console.log('å·²ä»Supabaseåˆ é™¤å†å²è®°å½•');
                }
                
                // ä»æœ¬åœ°æ•°ç»„åˆ é™¤
                const index = userHistory.findIndex(item => {
                    const match = item.id === historyId;
                    console.log(`æ¯”è¾ƒ: "${item.id}" === "${historyId}" => ${match}`);
                    return match;
                });
                
                console.log('æ‰¾åˆ°çš„ç´¢å¼•:', index);
                
                if (index !== -1) {
                    // ä»æœ¬åœ°æ•°ç»„åˆ é™¤
                    userHistory.splice(index, 1);
                    console.log('å·²ä»æœ¬åœ°æ•°ç»„åˆ é™¤å†å²è®°å½•ï¼Œæ–°é•¿åº¦:', userHistory.length);
                    
                    // æ›´æ–°localStorage
                    saveUserHistoryToStorage();
                    
                    // å¼ºåˆ¶é‡æ–°æ¸²æŸ“å†å²è®°å½•
                    console.log('å‡†å¤‡é‡æ–°æ¸²æŸ“å†å²è®°å½•...');
                    renderHistory();
                    console.log('å†å²è®°å½•ç•Œé¢å·²é‡æ–°æ¸²æŸ“');
                    
                    // å†æ¬¡ç¡®è®¤ç•Œé¢æ›´æ–°
                    setTimeout(() => {
                        console.log('å»¶è¿Ÿæ£€æŸ¥ç•Œé¢çŠ¶æ€...');
                        const currentHistoryItems = document.querySelectorAll('.history-item');
                        console.log('å½“å‰ç•Œé¢æ˜¾ç¤ºçš„å†å²è®°å½•é¡¹æ•°é‡:', currentHistoryItems.length);
                        console.log('userHistoryæ•°ç»„é•¿åº¦:', userHistory.length);
                        
                        if (currentHistoryItems.length !== userHistory.length) {
                            console.log('ç•Œé¢ä¸æ•°æ®ä¸åŒæ­¥ï¼Œå¼ºåˆ¶é‡æ–°æ¸²æŸ“');
                            renderHistory();
                        }
                    }, 200);
                    
                    showSuccessMessage('å†å²è®°å½•å·²åˆ é™¤');
                } else {
                    console.error('æœªæ‰¾åˆ°åŒ¹é…çš„å†å²è®°å½•é¡¹');
                    console.error('å¯èƒ½çš„åŸå› :');
                    console.error('1. historyIdç±»å‹ä¸åŒ¹é…');
                    console.error('2. userHistoryæ•°ç»„ä¸ºç©ºæˆ–æœªå®šä¹‰');
                    console.error('3. å†å²è®°å½•é¡¹çš„IDæ ¼å¼ä¸ä¸€è‡´');
                    
                    // å³ä½¿æ²¡æ‰¾åˆ°ï¼Œä¹Ÿå°è¯•åˆ·æ–°ç•Œé¢ï¼Œä»¥é˜²æ•°æ®ä¸åŒæ­¥
                    console.log('å°è¯•å¼ºåˆ¶åˆ·æ–°ç•Œé¢...');
                    setTimeout(() => {
                        renderHistory();
                        console.log('ç•Œé¢å·²å¼ºåˆ¶åˆ·æ–°');
                    }, 100);
                    
                    showError('æœªæ‰¾åˆ°è¦åˆ é™¤çš„å†å²è®°å½•ï¼Œä½†ç•Œé¢å·²åˆ·æ–°');
                }
                
                console.log('=== åˆ é™¤å†å²è®°å½•è°ƒè¯•ä¿¡æ¯ç»“æŸ ===');
                
            } catch (error) {
                console.error('åˆ é™¤å†å²è®°å½•é”™è¯¯:', error);
                showError('åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•
        async function clearAllHistory() {
            if (!currentUser) {
                showError('è¯·å…ˆç™»å½•');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }
            
            try {
                console.log('æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•...');
                
                // ä»Supabaseåˆ é™¤æ‰€æœ‰è®°å½•
                if (supabase) {
                    const { error } = await supabase
                        .from('history')
                        .delete()
                        .eq('user_id', currentUser.id);
                    
                    if (error) {
                        console.error('ä»Supabaseæ¸…ç©ºå¤±è´¥:', error);
                        showError('æ¸…ç©ºå¤±è´¥ï¼š' + error.message);
                        return;
                    }
                    
                    console.log('å·²ä»Supabaseæ¸…ç©ºæ‰€æœ‰å†å²è®°å½•');
                }
                
                // æ¸…ç©ºæœ¬åœ°æ•°ç»„
                userHistory = [];
                console.log('å·²æ¸…ç©ºæœ¬åœ°å†å²è®°å½•æ•°ç»„');
                
                // æ›´æ–°localStorage
                saveUserHistoryToStorage();
                
                // é‡æ–°æ¸²æŸ“å†å²è®°å½•
                renderHistory();
                
                showSuccessMessage('æ‰€æœ‰å†å²è®°å½•å·²æ¸…ç©º');
                
            } catch (error) {
                console.error('æ¸…ç©ºå†å²è®°å½•é”™è¯¯:', error);
                showError('æ¸…ç©ºå¤±è´¥ï¼š' + error.message);
            }
        }
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccessMessage(message) {
            // åˆ›å»ºæˆåŠŸæ¶ˆæ¯å…ƒç´ 
            let successDiv = document.getElementById('success-message');
            if (!successDiv) {
                successDiv = document.createElement('div');
                successDiv.id = 'success-message';
                successDiv.className = 'success-message';
                successDiv.innerHTML = `<p>${message}</p>`;
                
                // æ’å…¥åˆ°é”™è¯¯æ¶ˆæ¯åé¢
                const errorDiv = document.querySelector('.error');
                if (errorDiv && errorDiv.parentNode) {
                    errorDiv.parentNode.insertBefore(successDiv, errorDiv.nextSibling);
                }
            } else {
                successDiv.innerHTML = `<p>${message}</p>`;
            }
            
            successDiv.classList.add('show');
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                successDiv.classList.remove('show');
            }, 3000);
        }

        // éšè—é”™è¯¯
        function hideError() {
            document.querySelector('.error').classList.remove('show');
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(imageData) {
            console.log('showResult called with imageData:', imageData ? 'has data' : 'no data');
            
            currentImageData = imageData;
            
            const resultDiv = document.querySelector('.result');
            const placeholder = document.getElementById('initial-placeholder');
            
            console.log('Elements found:', {
                resultDiv: !!resultDiv,
                placeholder: !!placeholder
            });
            
            if (resultDiv) {
                // æ¢å¤ç»“æœåŒºåŸŸçš„åŸå§‹HTMLå†…å®¹
                resultDiv.innerHTML = `
                    <h3>ç”Ÿæˆç»“æœ</h3>
                    <div class="result-image-container">
                        <img id="result-image" src="data:image/png;base64,${imageData}" alt="ç”Ÿæˆçš„å›¾åƒ" onclick="showImageModal(this.src)" class="clickable-image">
                        <div class="image-hint">ç‚¹å‡»å›¾åƒå¯æ”¾å¤§æŸ¥çœ‹</div>
                    </div>
                    <div class="result-actions">
                        <button class="download-btn" onclick="downloadImage()">ä¸‹è½½å›¾åƒ</button>
                        <button class="reference-btn" onclick="referenceImage()" title="å¼•ç”¨æ­¤å›¾åƒè¿›è¡Œä¸‹ä¸€æ¬¡ç¼–è¾‘">ğŸ“ å¼•ç”¨å›¾åƒ</button>
                    </div>
                `;
                
                resultDiv.style.display = 'block';
                resultDiv.classList.add('show');
                console.log('å·²æ¢å¤ç»“æœåŒºåŸŸHTMLå¹¶æ·»åŠ showç±»');
            } else {
                console.error('æœªæ‰¾åˆ°result divå…ƒç´ ');
            }
            
            // ç¡®ä¿å ä½ç¬¦è¢«éšè—
            if (placeholder) {
                placeholder.style.display = 'none';
                console.log('å·²éšè—å ä½ç¬¦');
            } else {
                console.error('æœªæ‰¾åˆ°å ä½ç¬¦å…ƒç´ ');
            }
            
            console.log('showResultå®Œæˆï¼Œå½“å‰çŠ¶æ€:', {
                resultDivDisplay: resultDiv ? resultDiv.style.display : 'N/A',
                resultDivClasses: resultDiv ? resultDiv.className : 'N/A',
                placeholderDisplay: placeholder ? placeholder.style.display : 'N/A'
            });
        }

        // éšè—ç»“æœ
        function hideResult() {
            console.log('hideResult called');
            
            const resultDiv = document.querySelector('.result');
            const placeholder = document.getElementById('initial-placeholder');
            
            console.log('Elements found:', {
                resultDiv: !!resultDiv,
                placeholder: !!placeholder
            });
            
            if (resultDiv) {
                resultDiv.classList.remove('show');
                resultDiv.style.display = 'none';
                console.log('å·²éšè—result div');
            } else {
                console.error('æœªæ‰¾åˆ°result divå…ƒç´ ');
            }
            
            if (placeholder) {
                placeholder.style.display = 'block';
                console.log('å·²æ˜¾ç¤ºå ä½ç¬¦');
            } else {
                console.error('æœªæ‰¾åˆ°å ä½ç¬¦å…ƒç´ ');
            }
        }



        // æ˜¾ç¤ºå›¾åƒæ”¾å¤§æ¨¡æ€æ¡†
        function showImageModal(imageSrc) {
            const modal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            
            if (modal && modalImage) {
                // æ˜¾ç¤ºæ¨¡æ€æ¡† - ä¸è®¾ç½®ä»»ä½•ä½ç½®ï¼Œå®Œå…¨ä¾èµ–CSSçš„position: fixed
                modal.style.display = 'block';
                
                // è®¾ç½®å›¾åƒæº
                modalImage.src = imageSrc;
                
                // ç­‰å¾…å›¾åƒåŠ è½½å®Œæˆååº”ç”¨åŠ¨ç”»æ•ˆæœ
                modalImage.onload = function() {
                    // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
                    document.body.style.overflow = 'hidden';
                    
                    // è®¾ç½®åˆå§‹çŠ¶æ€ï¼ˆé€æ˜ï¼‰
                    modal.style.opacity = '0';
                    modal.style.transition = 'opacity 0.3s ease';
                    
                    // åº”ç”¨æ·¡å…¥åŠ¨ç”»
                    requestAnimationFrame(() => {
                        modal.style.opacity = '1';
                    });
                    
                    // å›¾åƒåŠ è½½å®Œæˆåçš„æ ·å¼
                    modalImage.style.opacity = '1';
                    modalImage.style.transition = 'opacity 0.3s ease';
                };
                
                // è®¾ç½®å›¾åƒåŠ è½½ä¸­çš„çŠ¶æ€
                modalImage.style.opacity = '0';
                modalImage.style.transition = 'opacity 0.3s ease';
                
                // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
                document.addEventListener('keydown', handleModalKeyboard);
            }
        }

        // å…³é—­å›¾åƒæ”¾å¤§æ¨¡æ€æ¡†
        function closeImageModal() {
            const modal = document.getElementById('image-modal');
            
            if (modal) {
                // ç¬¬ä¸€æ­¥ï¼šåº”ç”¨æ·¡å‡ºåŠ¨ç”»
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s ease';
                
                // ç¬¬äºŒæ­¥ï¼šåŠ¨ç”»å®Œæˆåéšè—æ¨¡æ€æ¡†å¹¶é‡ç½®çŠ¶æ€
                setTimeout(() => {
                    // éšè—æ¨¡æ€æ¡†
                    modal.style.display = 'none';
                    
                    // æ¢å¤èƒŒæ™¯æ»šåŠ¨
                    document.body.style.overflow = 'auto';
                    
                    // é‡ç½®é€æ˜åº¦ï¼Œä¸ºä¸‹æ¬¡æ˜¾ç¤ºåšå‡†å¤‡
                    modal.style.opacity = '1';
                }, 300);
                
                // ç§»é™¤é”®ç›˜äº‹ä»¶ç›‘å¬
                document.removeEventListener('keydown', handleModalKeyboard);
            }
        }

        // å¤„ç†æ¨¡æ€æ¡†é”®ç›˜äº‹ä»¶
        function handleModalKeyboard(event) {
            if (event.key === 'Escape') {
                closeImageModal();
            }
        }



        // å¼•ç”¨å›¾åƒè¿›è¡Œç¼–è¾‘
        function referenceImage() {
            if (!currentImageData) {
                showError('æ²¡æœ‰å¯å¼•ç”¨çš„å›¾åƒ');
                return;
            }

            // åˆ‡æ¢åˆ°Editoræ ‡ç­¾é¡µçš„å›¾åƒç¼–è¾‘åŠŸèƒ½
            switchMainTab('editor');
            switchEditorTab('multi-image');
            
            // æ¸…ç©ºå½“å‰å¤šå›¾é€‰æ‹©
            selectedMultiFiles = [];
            
            // æ¸…ç©ºæç¤ºè¯
            const multiPrompt = document.getElementById('multi-prompt');
            if (multiPrompt) {
                multiPrompt.value = '';
                console.log('å·²æ¸…ç©ºå›¾åƒç¼–è¾‘æç¤ºè¯');
            }
            
            // å°†å¼•ç”¨çš„å›¾åƒæ·»åŠ åˆ°å¤šå›¾é€‰æ‹©ä¸­
            addReferencedImageToMulti(currentImageData);
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showSuccessMessage('å›¾åƒå·²å¼•ç”¨åˆ°å›¾åƒç¼–è¾‘åŒºåŸŸï¼Œæ‚¨å¯ä»¥ç»§ç»­æ·»åŠ æ›´å¤šå›¾åƒè¿›è¡Œä¸‹ä¸€æ­¥ç¼–è¾‘');
        }





        // è®¾ç½®å¼•ç”¨çš„å›¾åƒ
        function setReferencedImage(base64Data) {
            // åˆ›å»ºå›¾åƒæ–‡ä»¶å¯¹è±¡
            const byteCharacters = atob(base64Data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'image/png' });
            
            // åˆ›å»ºæ–‡ä»¶å¯¹è±¡
            const file = new File([blob], 'referenced_image.png', { type: 'image/png' });
            
            // è®¾ç½®ä¸ºé€‰ä¸­çš„æ–‡ä»¶
            selectedFile = file;
            
            // æ›´æ–°é¢„è§ˆ
            updateImagePreview(file);
        }

        // ä»å›¾åƒæºè®¾ç½®å¼•ç”¨çš„å›¾åƒ
        function setReferencedImageFromSrc(imageSrc) {
            // åˆ›å»ºå›¾åƒæ–‡ä»¶å¯¹è±¡
            fetch(imageSrc)
                .then(response => response.blob())
                .then(blob => {
                    const file = new File([blob], 'referenced_image.png', { type: 'image/png' });
                    selectedFile = file;
                    updateImagePreview(file);
                })
                .catch(error => {
                    console.error('å¼•ç”¨å›¾åƒå¤±è´¥:', error);
                    showError('å¼•ç”¨å›¾åƒå¤±è´¥');
                });
        }

        // å°†å¼•ç”¨çš„å›¾åƒæ·»åŠ åˆ°å¤šå›¾é€‰æ‹©ä¸­
        function addReferencedImageToMulti(base64Data) {
            // åˆ›å»ºå›¾åƒæ–‡ä»¶å¯¹è±¡
            const byteCharacters = atob(base64Data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'image/png' });
            
            // åˆ›å»ºæ–‡ä»¶å¯¹è±¡
            const file = new File([blob], 'referenced_image.png', { type: 'image/png' });
            
            // æ·»åŠ åˆ°å¤šå›¾é€‰æ‹©ä¸­
            selectedMultiFiles.push(file);
            
            // æ›´æ–°å¤šå›¾é¢„è§ˆ
            updateMultiImagePreview();
            
            // æ˜¾ç¤ºæ™ºèƒ½æç¤º
            showReferenceHint();
        }

        // æ˜¾ç¤ºå¼•ç”¨æç¤º
        function showReferenceHint() {
            const count = selectedMultiFiles.length;
            if (count === 1) {
                showSuccessMessage('å›¾åƒå·²å¼•ç”¨ï¼æ‚¨å¯ä»¥ç»§ç»­æ·»åŠ æ›´å¤šå›¾åƒï¼ˆæœ€å¤š3å¼ ï¼‰ï¼Œæˆ–ç›´æ¥ç”Ÿæˆæ–°å›¾åƒ');
            } else if (count === 2) {
                showSuccessMessage('å·²å¼•ç”¨2å¼ å›¾åƒï¼æ‚¨å¯ä»¥å†æ·»åŠ 1å¼ å›¾åƒï¼Œæˆ–ç›´æ¥ç”Ÿæˆæ–°å›¾åƒ');
            } else if (count === 3) {
                showSuccessMessage('å·²å¼•ç”¨3å¼ å›¾åƒï¼å›¾åƒæ•°é‡å·²æ»¡ï¼Œæ‚¨å¯ä»¥å¼€å§‹ç”Ÿæˆæ–°å›¾åƒ');
            }
        }



        // æ–‡ä»¶è½¬æ¢ä¸ºbase64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    resolve(reader.result);
                };
                reader.onerror = error => reject(error);
            });
        }

        // è°ƒè¯•ç‰ˆæœ¬çš„å“åº”å¤„ç†å‡½æ•°
        function handleAPIResponse(data, functionName) {
            console.log(`${functionName} API Response:`, data);
            console.log(`${functionName} Response structure check:`, {
                hasCandidates: !!data.candidates,
                candidatesLength: data.candidates?.length,
                hasContent: !!(data.candidates?.[0]?.content),
                hasParts: !!(data.candidates?.[0]?.content?.parts),
                partsLength: data.candidates?.[0]?.content?.parts?.length,
                parts: data.candidates?.[0]?.content?.parts?.map(part => ({
                    hasText: !!part.text,
                    hasInlineData: !!(part.inline_data || part.inlineData),
                    inlineDataType: (part.inline_data || part.inlineData)?.mime_type || (part.inline_data || part.inlineData)?.mimeType
                }))
            });
            
            if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
                for (const part of data.candidates[0].content.parts) {
                    console.log(`${functionName} Processing part:`, part);
                    
                    // æ£€æŸ¥æ–‡æœ¬å“åº”
                    if (part.text) {
                        console.log(`${functionName} Found text part:`, part.text);
                    }
                    
                    // æ£€æŸ¥å›¾åƒæ•°æ® - æ”¯æŒä¸¤ç§å‘½åæ–¹å¼
                    const inlineData = part.inline_data || part.inlineData;
                    if (inlineData && inlineData.data) {
                        console.log(`${functionName} Found image data, mime_type:`, inlineData.mime_type || inlineData.mimeType);
                        showResult(inlineData.data);
                        return true; // æˆåŠŸæ‰¾åˆ°å›¾åƒ
                    }
                }
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å›¾åƒæ•°æ®ï¼Œæ˜¾ç¤ºæ‰€æœ‰partsçš„è¯¦ç»†ä¿¡æ¯
                const partsInfo = data.candidates[0].content.parts.map(part => {
                    if (part.text) return `Text: "${part.text.substring(0, 200)}..."`;
                    const inlineData = part.inline_data || part.inlineData;
                    if (inlineData) return `Image: ${inlineData.mime_type || inlineData.mimeType}`;
                    return `Unknown part: ${JSON.stringify(part)}`;
                }).join('\n');
                
                throw new Error(`${functionName}: å“åº”ä¸­æœªæ‰¾åˆ°å›¾åƒæ•°æ®ã€‚å“åº”å†…å®¹:\n${partsInfo}`);
            } else {
                throw new Error(`${functionName}: APIè¿”å›æ ¼å¼é”™è¯¯: ${JSON.stringify(data)}`);
            }
        }

        // æ–‡æœ¬ç”Ÿæˆå›¾åƒ
        async function generateFromText() {
            const prompt = document.getElementById('text-prompt').value.trim();
            
            if (!prompt) {
                showError('è¯·è¾“å…¥æè¿°æç¤ºè¯');
                return;
            }

            hideError();
            hideResult();
            showLoading();
            
            // æ˜¾ç¤ºç”ŸæˆçŠ¶æ€æç¤º
            showGenerationStatus('æ­£åœ¨ç”Ÿæˆå›¾åƒ');

            try {
                const response = await fetch(`${API_BASE}/api/generate-image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    let errorMessage = `HTTPé”™è¯¯: ${response.status}`;
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.error?.message || errorMessage;
                    } catch (e) {
                        // å¦‚æœæ— æ³•è§£æé”™è¯¯å“åº”ï¼Œä½¿ç”¨é»˜è®¤é”™è¯¯æ¶ˆæ¯
                        errorMessage = errorText || errorMessage;
                    }
                    
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                const result = handleAPIResponse(data, 'generateFromText');
                console.log('generateFromText: handleAPIResponseç»“æœ:', result);
                console.log('generateFromText: currentImageData:', currentImageData);
                
                if (result && currentImageData) {
                    console.log('generateFromText: å‡†å¤‡ä¿å­˜åˆ°å†å²è®°å½•');
                    // ä¿å­˜åˆ°å†å²è®°å½•
                    saveToHistory('text-to-image', prompt, [], `data:image/png;base64,${currentImageData}`);
                } else {
                    console.log('generateFromText: æ— æ³•ä¿å­˜åˆ°å†å²è®°å½•ï¼Œresult:', result, 'currentImageData:', currentImageData);
                }
            } catch (error) {
                console.error('ç”Ÿæˆå›¾åƒé”™è¯¯:', error);
                hideGenerationStatus(); // æ¸…é™¤ç”ŸæˆçŠ¶æ€
                showError(`ç”Ÿæˆå›¾åƒå¤±è´¥: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        

        // ä¸‹è½½å›¾åƒ
        function downloadImage() {
            if (!currentImageData) {
                showError('æ²¡æœ‰å¯ä¸‹è½½çš„å›¾åƒ');
                return;
            }

            downloadImageFromSrc(`data:image/png;base64,${currentImageData}`);
        }

        // é€šç”¨å›¾åƒä¸‹è½½å‡½æ•°
        function downloadImageFromSrc(imageSrc) {
            if (!imageSrc) {
                showError('æ²¡æœ‰å¯ä¸‹è½½çš„å›¾åƒ');
                return;
            }

            const link = document.createElement('a');
            link.href = imageSrc;
            link.download = `nano_banana_generated_${Date.now()}.png`;

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
        const fileInputDisplay = document.querySelector('.file-input-display');
        
        fileInputDisplay.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileInputDisplay.style.borderColor = '#764ba2';
            fileInputDisplay.style.background = '#e9ecef';
        });

        fileInputDisplay.addEventListener('dragleave', (e) => {
            e.preventDefault();
            fileInputDisplay.style.borderColor = '#667eea';
            fileInputDisplay.style.background = '#f8f9fa';
        });

        fileInputDisplay.addEventListener('drop', (e) => {
            e.preventDefault();
            fileInputDisplay.style.borderColor = '#667eea';
            fileInputDisplay.style.background = '#f8f9fa';
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                // ç›´æ¥è®¾ç½®selectedFileè€Œä¸ä¾èµ–input.files
                const file = files[0];
                selectedFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-img').src = e.target.result;
                    document.getElementById('image-preview').style.display = 'block';
                    document.getElementById('file-display-text').textContent = file.name;
                    document.querySelector('.file-input-display').classList.add('has-file');
                };
                reader.readAsDataURL(file);
                
                // å°è¯•åŒæ—¶è®¾ç½®input.filesç”¨äºå…¼å®¹æ€§
                const fileInput = document.getElementById('source-image');
                try {
                    fileInput.files = files;
                } catch(e) {
                    // æŸäº›æµè§ˆå™¨ä¸å…è®¸è®¾ç½®fileså±æ€§ï¼Œä½†selectedFileå·²ç»è®¾ç½®äº†
                    console.log('Could not set input.files, but selectedFile is set');
                }
            }
        });

        // å¤šå›¾ä¸Šä¼ ç›¸å…³å˜é‡
        let currentUploadMode = 'multiple'; // å›ºå®šä¸ºå¤šå›¾æ¨¡å¼

        // å¤„ç†å›¾åƒä¸Šä¼ ï¼ˆå¤šå›¾æ¨¡å¼ï¼‰
        function handleImageUpload(input) {
            addMultipleImages(input);
        }



        // æ·»åŠ å¤šå¼ å›¾åƒ
        function addMultipleImages(input) {
            const files = Array.from(input.files);
            
            if (files.length === 0) {
                return;
            }
            
            // æ£€æŸ¥æ€»æ•°é‡æ˜¯å¦è¶…è¿‡é™åˆ¶
            if (selectedMultiFiles.length + files.length > 3) {
                alert(`å½“å‰å·²é€‰æ‹© ${selectedMultiFiles.length} å¼ å›¾åƒï¼Œæœ€å¤šåªèƒ½å†æ·»åŠ  ${3 - selectedMultiFiles.length} å¼ `);
                input.value = '';
                return;
            }
            
            // é€ä¸ªéªŒè¯å’Œæ·»åŠ æ–‡ä»¶
            for (const file of files) {
                // éªŒè¯æ–‡ä»¶æ ¼å¼
                if (!file.type.startsWith('image/')) {
                    alert(`æ–‡ä»¶ ${file.name} ä¸æ˜¯æœ‰æ•ˆçš„å›¾åƒæ–‡ä»¶ï¼Œè·³è¿‡`);
                    continue;
                }
                
                // åªå…è®¸JPEGå’ŒPNGæ ¼å¼
                if (file.type !== 'image/jpeg' && file.type !== 'image/jpg' && file.type !== 'image/png') {
                    alert(`æ–‡ä»¶ ${file.name} æ ¼å¼ä¸æ”¯æŒï¼Œè·³è¿‡ã€‚è¯·ä½¿ç”¨JPEGæˆ–PNGæ ¼å¼ã€‚`);
                    continue;
                }
                
                // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º10MBï¼‰
                if (file.size > 10 * 1024 * 1024) {
                    alert(`æ–‡ä»¶ ${file.name} å¤ªå¤§ï¼Œè·³è¿‡ã€‚è¯·é€‰æ‹©å°äº10MBçš„å›¾åƒã€‚`);
                    continue;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåæ–‡ä»¶
                const existingFile = selectedMultiFiles.find(f => f.name === file.name);
                if (existingFile) {
                    alert(`æ–‡ä»¶ ${file.name} å·²å­˜åœ¨ï¼Œè·³è¿‡`);
                    continue;
                }
                
                // æ·»åŠ æ–‡ä»¶åˆ°æ•°ç»„
                selectedMultiFiles.push(file);
            }
            
            // æ›´æ–°é¢„è§ˆ
            updateMultiImagePreview();
            
            // æ¸…ç©ºinputå€¼
            input.value = '';
        }

        // æ›´æ–°å¤šå›¾é¢„è§ˆ
        function updateMultiImagePreview() {
            const previewContainer = document.getElementById('multi-image-preview');
            const previewImages = document.getElementById('multi-preview-images');
            const fileDisplay = document.querySelector('.multi-file-input-display');
            const fileDisplayText = document.getElementById('multi-file-display-text');
            const imageCount = document.getElementById('image-count');
            
            // æ›´æ–°å›¾åƒè®¡æ•°
            if (imageCount) {
                imageCount.textContent = selectedMultiFiles.length;
            }
            
            // æ¸…ç©ºé¢„è§ˆåŒºåŸŸ
            previewImages.innerHTML = '';
            
            if (selectedMultiFiles.length > 0) {
                previewContainer.style.display = 'block';
                fileDisplay.classList.add('has-files');
                fileDisplayText.textContent = `å·²æ·»åŠ  ${selectedMultiFiles.length} å¼ å›¾åƒï¼Œç‚¹å‡»å¯ç»§ç»­ä¸Šä¼ `;
                
                selectedMultiFiles.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'multi-preview-item';
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'multi-preview-image';
                        img.alt = `é¢„è§ˆå›¾åƒ ${index + 1}`;
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-image-btn';
                        removeBtn.innerHTML = 'Ã—';
                        removeBtn.onclick = function() {
                            removeMultiImage(index);
                        };
                        
                        previewItem.appendChild(img);
                        previewItem.appendChild(removeBtn);
                        previewImages.appendChild(previewItem);
                    };
                    reader.readAsDataURL(file);
                });
            } else {
                previewContainer.style.display = 'none';
                fileDisplay.classList.remove('has-files');
                fileDisplayText.textContent = 'ç‚¹å‡»é€‰æ‹©å¤šå¼ å›¾åƒæ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„';
            }
        }

        // ç§»é™¤å¤šå›¾ä¸­çš„æŸå¼ å›¾åƒ
        function removeMultiImage(index) {
            selectedMultiFiles.splice(index, 1);
            
            // æ›´æ–°é¢„è§ˆ
            updateMultiImagePreview();
        }

        // æ¸…ç©ºæ‰€æœ‰å›¾åƒ
        function clearAllImages() {
            if (selectedMultiFiles.length === 0) {
                return;
            }
            
            if (confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ ${selectedMultiFiles.length} å¼ å›¾åƒå—ï¼Ÿ`)) {
                selectedMultiFiles = [];
                updateMultiImagePreview();
            }
        }

        // å›¾åƒç¼–è¾‘åŠŸèƒ½
        async function generateFromMultiImages() {
            const prompt = document.getElementById('multi-prompt').value.trim();
            
            if (!prompt) {
                showError('è¯·è¾“å…¥æè¿°æç¤ºè¯');
                return;
            }
            
            if (selectedMultiFiles.length === 0) {
                showError('è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ å›¾åƒ');
                return;
            }
            
            if (selectedMultiFiles.length > 3) {
                showError('æœ€å¤šåªèƒ½é€‰æ‹©3å¼ å›¾åƒ');
                return;
            }
            
            showLoading();
            hideError();
            hideResult();
            
            // æ˜¾ç¤ºç”ŸæˆçŠ¶æ€æç¤º
            showGenerationStatus('æ­£åœ¨ç”Ÿæˆå›¾åƒ');
            
            try {
                // å‡†å¤‡è¯·æ±‚æ•°æ®
                const contents = [];
                
                // æ·»åŠ å›¾åƒ
                for (const file of selectedMultiFiles) {
                    const base64Data = await fileToBase64(file);
                    // ç¡®ä¿å›¾åƒæ ¼å¼æ­£ç¡®ï¼Œåªæ”¯æŒJPEGå’ŒPNG
                    let mimeType = file.type;
                    if (mimeType === 'image/jpeg' || mimeType === 'image/jpg') {
                        mimeType = 'image/jpeg';
                    } else if (mimeType === 'image/png') {
                        mimeType = 'image/png';
                    } else {
                        throw new Error(`ä¸æ”¯æŒçš„å›¾åƒæ ¼å¼: ${mimeType}ã€‚è¯·ä½¿ç”¨JPEGæˆ–PNGæ ¼å¼ã€‚`);
                    }
                    
                    contents.push({
                        inline_data: {
                            mime_type: mimeType,
                            data: base64Data.split(',')[1]
                        }
                    });
                }
                
                // æ·»åŠ æ–‡æœ¬æç¤ºè¯
                contents.push({
                    text: prompt
                });
                
                const requestBody = {
                    contents: [{
                        parts: contents
                    }]
                };
                
                console.log('Multi-image generation request:', requestBody);
                

                
                const response = await fetch(`${API_BASE}/api/generate-multi-image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    const errorData = data.error || {};
                    const errorMessage = errorData.message || `HTTP ${response.status}: ${response.statusText}`;
                    

                    
                    throw new Error(errorMessage);
                }
                

                
                const result = handleAPIResponse(data, 'Multi-image generation');
                console.log('generateFromMultiImages: handleAPIResponseç»“æœ:', result);
                console.log('generateFromMultiImages: currentImageData:', currentImageData);
                
                if (result && currentImageData) {
                    console.log('generateFromMultiImages: å‡†å¤‡ä¿å­˜åˆ°å†å²è®°å½•');
                    // ä¿å­˜åˆ°å†å²è®°å½•
                    const inputImages = selectedMultiFiles.map(file => {
                        // è¿™é‡Œåº”è¯¥å°†æ–‡ä»¶è½¬æ¢ä¸ºbase64ï¼Œä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬ä½¿ç”¨å ä½ç¬¦
                        return 'data:image/png;base64,placeholder';
                    });
                    saveToHistory('image-edit', prompt, inputImages, `data:image/png;base64,${currentImageData}`);
                } else {
                    console.log('generateFromMultiImages: æ— æ³•ä¿å­˜åˆ°å†å²è®°å½•ï¼Œresult:', result, 'currentImageData:', currentImageData);
                }
                
            } catch (error) {
                console.error('Multi-image generation error:', error);
                hideGenerationStatus(); // æ¸…é™¤ç”ŸæˆçŠ¶æ€
                showError(`å›¾åƒç¼–è¾‘å¤±è´¥: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // ä¸ºå¤šå›¾ä¸Šä¼ æ·»åŠ æ‹–æ‹½æ”¯æŒ
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–ä¸Šä¼ æ¨¡å¼
            switchUploadMode();
            
            // æ·»åŠ æ¨¡æ€æ¡†å¤–éƒ¨ç‚¹å‡»å…³é—­åŠŸèƒ½
            const imageModal = document.getElementById('image-modal');
            if (imageModal) {
                imageModal.addEventListener('click', function(e) {
                    if (e.target === imageModal) {
                        closeImageModal();
                    }
                });
            }
            
            // æ·»åŠ ESCé”®å…³é—­æ¨¡æ€æ¡†åŠŸèƒ½
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeImageModal();
                }
            });


            
            const multiFileInputDisplay = document.querySelector('.multi-file-input-display');
            
            if (multiFileInputDisplay) {
                multiFileInputDisplay.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.style.background = '#e9ecef';
                });
                
                multiFileInputDisplay.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.style.background = '#f8f9fa';
                });
                
                multiFileInputDisplay.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.style.background = '#f8f9fa';
                    
                    const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
                    
                    if (files.length > 0) {
                        // å¤šå›¾æ¨¡å¼ï¼šå¤„ç†æ‰€æœ‰å›¾åƒ
                        for (const file of files) {
                            if (selectedMultiFiles.length >= 3) {
                                alert('å·²è¾¾åˆ°æœ€å¤§å›¾åƒæ•°é‡é™åˆ¶ï¼ˆ3å¼ ï¼‰');
                                break;
                            }
                            processDroppedFile(file);
                        }
                        
                        // æ›´æ–°é¢„è§ˆ
                        updateMultiImagePreview();
                    }
                });
            }
        });

        // å¤„ç†æ‹–æ‹½æ–‡ä»¶çš„è¾…åŠ©å‡½æ•°
        function processDroppedFile(file) {
            // éªŒè¯æ–‡ä»¶æ ¼å¼
            if (file.type !== 'image/jpeg' && file.type !== 'image/jpg' && file.type !== 'image/png') {
                alert(`æ–‡ä»¶ ${file.name} æ ¼å¼ä¸æ”¯æŒã€‚è¯·ä½¿ç”¨JPEGæˆ–PNGæ ¼å¼ã€‚`);
                return false;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            if (file.size > 10 * 1024 * 1024) {
                alert(`æ–‡ä»¶ ${file.name} å¤ªå¤§ã€‚è¯·é€‰æ‹©å°äº10MBçš„å›¾åƒã€‚`);
                return false;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåæ–‡ä»¶
            const existingFile = selectedMultiFiles.find(f => f.name === file.name);
            if (existingFile) {
                alert(`æ–‡ä»¶ ${file.name} å·²å­˜åœ¨ï¼Œè·³è¿‡`);
                return false;
            }
            
            // æ·»åŠ æ–‡ä»¶åˆ°æ•°ç»„
            selectedMultiFiles.push(file);
            return true;
        }
    </script>
</body>
</html>